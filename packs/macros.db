{"name":"05 - Glow","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n[{\r\n    filterType: \"glow\",\r\n    filterId: \"superSpookyGlow\",\r\n    outerStrength: 4,\r\n    innerStrength: 0,\r\n    color: 0x5099DD,\r\n    quality: 0.5,\r\n    padding: 10,\r\n    animated:\r\n    {\r\n        color: \r\n        {\r\n           active: true, \r\n           loopDuration: 3000, \r\n           animType: \"colorOscillation\", \r\n           val1:0x5099DD, \r\n           val2:0x90EEFF\r\n        }\r\n    }\r\n}];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Compendium.tokenmagic.tmMacros.g7O4u4dTaWcnajW7"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"I2CwYQUNWm5iRWOV"}
{"_id":"I2CwYQUNWm5iRWOV","name":"05 - Glow","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n[{\r\n    filterType: \"glow\",\r\n    filterId: \"superSpookyGlow\",\r\n    outerStrength: 4,\r\n    innerStrength: 0,\r\n    color: 0x5099DD,\r\n    quality: 0.5,\r\n    padding: 10,\r\n    animated:\r\n    {\r\n        color: \r\n        {\r\n           active: true, \r\n           loopDuration: 3000, \r\n           animType: \"colorOscillation\", \r\n           val1:0x5099DD, \r\n           val2:0x90EEFF\r\n        }\r\n    }\r\n}];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Compendium.tokenmagic.tmMacros.g7O4u4dTaWcnajW7"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}}}
{"name":"24 - T02 - Fire Shield 3 - Ring","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\n[{\n    filterType: \"zapshadow\",\n    filterId: \"myZap\",\n    alphaTolerance: 0.45\n},{\n    filterType: \"field\",\n    filterId: \"myFireField\",\n    shieldType: 1,\n    gridPadding: 1.1,\n    color: 0x7BDF62,\n    time: 0,\n    blend: 2,\n    intensity: 1.2,\n    lightAlpha: 1,\n    lightSize: 0.7,\n    scale: 0.3,\n    radius: 0.1,\n    chromatic: false,\n    discardThreshold: 0.7,\n    hideRadius: 0.75,\n    alphaDiscard: true,\n    animated :\n    {\n      time : \n      { \n        active: true, \n        speed: 0.0015, \n        animType: \"move\" \n      }\n    }\n},{\n    filterType: \"xglow\",\n    filterId: \"myBurningAura\",\n    auraType: 2,\n    color: 0x7BDF62,\n    thickness: 5.8,\n    scale: 3.,\n    time: 0,\n    auraIntensity: 2,\n    subAuraIntensity: 1.5,\n    threshold: 0.20,\n    discard: true,\n    zOrder: 3000,\n    animated:\n    {\n        time : \n        {  \n           active: true,\n           speed: 0.0027, \n           animType: \"move\" \n        },\n        thickness:\n        {\n           active: true,\n           loopDuration: 3000, \n           animType: \"cosOscillation\", \n           val1:2, \n           val2:5\n        }\n    }\n}];\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"core":{"sourceId":"Compendium.world.token-magic-dev.Uw5icMEGsNrCToeV"},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"24 - T02 - Fire Shield 3 - Ring","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"gvLWLbBdu6RXI0J1"}
{"name":"26 - T02 - Mantle of Madness (liquid)","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n[{\r\n    filterType: \"liquid\",\r\n    filterId: \"myMantle\",\r\n    color: 0x0090FF,\r\n    time: 0,\r\n    blend: 5,\r\n    intensity: 0.0001,\r\n    spectral: false,\r\n    scale: 7,\r\n    animated :\r\n    {\r\n       time : \r\n       { \r\n          active: true, \r\n          speed: 0.0015, \r\n          animType: \"move\" \r\n       },\r\n       intensity : \r\n       { \r\n          active: true, \r\n          animType: \"syncCosOscillation\",\r\n          loopDuration: 30000,\r\n          val1: 0.0001, \r\n          val2: 4 \r\n       },\r\n       scale: \r\n       { \r\n          active: true, \r\n          animType: \"syncCosOscillation\",\r\n          loopDuration: 30000,\r\n          val1: 7, \r\n          val2: 1 \r\n       }\r\n    }\r\n}];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.8nsxKDYhS1Wcc139"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"YHE4XqS7fKhyDS59"}
{"name":"AA ApplyEffectsToTemplate","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"//On use macro to apply an item's active effects to the placed template instead of applying through the normal midi QoL workflow \n// requires midi qol, furnace and Active Auras \nlet template = canvas.templates.get(args[0].templateId)\nlet effects = args[0].item.effects\nlet templateEffectData = []\nfor( let effect of effects){\n   let data = { data: duplicate(effect), parentActorId: false, parentActorLink: false, entityType: \"template\", entityId:template.id, }\n   templateEffectData.push(data)\n}\nawait template.setFlag(\"ActiveAuras\", \"IsAura\", templateEffectData)\nActiveAuras.CollateAuras(canvas.scene._id, true, false, \"spellCast\")\nreturn  {haltEffectsApplication: true}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.fHwT4N13IcbW4D3I"},"combat-utility-belt":{"macroTrigger":""},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"Gqz3wVrpLRey6niS"}
{"_id":"Gqz3wVrpLRey6niS","name":"AA ApplyEffectsToTemplate","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"//On use macro to apply an item's active effects to the placed template instead of applying through the normal midi QoL workflow \n// requires midi qol, furnace and Active Auras \nlet template = canvas.templates.get(args[0].templateId)\nlet disposition = args[0].actor.token.disposition\nlet effects = args[0].item.effects\nlet templateEffectData = []\nfor( let effect of effects){\n   let data = { data: duplicate(effect), parentActorId: false, parentActorLink: false, entityType: \"template\", entityId:template.id, casterDisposition: disposition, castLevel: args[0].spellLevel}\ndata.data.origin = `Actor.${args[0].actor._id}.Item.${args[0].item._id}`\n   templateEffectData.push(data)\n}\nawait template.setFlag(\"ActiveAuras\", \"IsAura\", templateEffectData)\nAAhelpers.UserCollateAuras(canvas.scene._id, true, false, \"spellCast\")\nreturn  {haltEffectsApplication: true}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.fHwT4N13IcbW4D3I"},"combat-utility-belt":{"macroTrigger":""},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"},"advanced-macros":{"runAsGM":false}}}
{"name":"AA Grease","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"if (!game.modules.get(\"advanced-macros\")?.active) ui.notifications.error(\"Advanced Macros is not enabled\")\nif (!game.modules.get(\"combat-utility-belt\")?.active) ui.notifications.error(\"CUB is not enabled\")\n\nif (args[0] === \"on\") {\n\n    const lastArg = args[args.length - 1];\n    let tactor;\n    if (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\n    else tactor = game.actors.get(lastArg.actorId);\n    const target = canvas.tokens.get(lastArg.tokenId)\n\n    const flavor = `${CONFIG.DND5E.abilities[\"dex\"]} DC${args[1]} Grease}`;\n    let saveRoll = (await tactor.rollAbilitySave(\"dex\", { flavor }))?.total;\n    if (saveRoll < args[1]) {\n        game.cub.addCondition(\"Prone\", target)\n    }\n}\n\nelse if (args[0] === \"each\") {\n\n    const lastArg = args[args.length - 1];\n    let tactor;\n    if (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\n    else tactor = game.actors.get(lastArg.actorId);\n    const target = canvas.tokens.get(lastArg.tokenId)\n    const DAEitem = lastArg.efData.flags.dae.itemData\n    const saveData = DAEitem.data.save\n    const flavor = `${CONFIG.DND5E.abilities[\"dex\"]} DC${args[1]} ${DAEitem?.name || \"\"}`;\n    let saveRoll = (await tactor.rollAbilitySave(\"dex\", { flavor }))?.total;\n    if (saveRoll < args[1]) {\n        game.cub.addCondition(\"Prone\", target)\n    }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"advanced-macros":{"runAsGM":false},"core":{"sourceId":"Macro.M6BXTCUueDACm0d0"},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"AA Grease","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"Culwz8ek4VJvcwsf"}
{"name":"AA Moonbeam","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"if (args[0] === \"on\" || args[0] === \"each\") {\n    const lastArg = args[args.length - 1];\n    let tactor;\n    if (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\n    else tactor = game.actors.get(lastArg.actorId);\n    const target = canvas.tokens.get(lastArg.tokenId)\n    const flavor = `${CONFIG.DND5E.abilities[\"dex\"]} DC${args[1]} \"Moonbeam\"}`;\n    let saveRoll = (await tactor.rollAbilitySave(\"dex\", { flavor })).total;\n    let damageRoll =  new Roll(`${args[2]}d10`).roll()\n    game.dice3d?.showForRoll(damageRoll)\n    let targets = new Set();\n    let saves = new Set();\n    targets.add(target);\n    saves.add(target);\n    if (saveRoll > args[1]) {\n        saves.add(target)\n        MidiQOL.applyTokenDamage([{ damage: damageRoll.total/2, type: \"radiant\" }], damageRoll.total, targets, null, saves);\n    }\n    else{\n        MidiQOL.applyTokenDamage([{ damage: damageRoll.total, type: \"radiant\" }], damageRoll.total, targets, null, saves);\n    }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"advanced-macros":{"runAsGM":false},"core":{"sourceId":"Macro.wWR0eKHRS4cbJu6b"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"HWh6dwdeB0WtijaO"}
{"name":"AA Petrifying","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"if (args[0] === \"on\" || args[0] === \"each\") {\n    const lastArg = args[args.length - 1];\n    let tactor;\n    if (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\n    else tactor = game.actors.get(lastArg.actorId);\n    const target = canvas.tokens.get(lastArg.tokenId)\n    if (tactor.data.data.traits.di.value.includes(\"petrified\")) return\n    const flavor = `${CONFIG.DND5E.abilities[\"con\"]} DC${args[1]} Petrifying Mist`;\n    let saveRoll = (await tactor.rollAbilitySave(\"con\", { flavor }))?.total;\n    if(!saveRoll) return;\n\n    if (saveRoll < args[1]) {\n        ChatMessage.create({ content: `${token.name} começa a ser congelado` })\n    } else {\n        ChatMessage.create({ content: `${token.name} saves against Petrifying Mist` })\n    }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.muUKx4rkxJpln4vp"},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"AA StinkingCloud","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"aAaWnttas5HAZdcE"}
{"name":"AA StinkingCloud","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"if (args[0] === \"on\" || args[0] === \"each\") {\n    const lastArg = args[args.length - 1];\n    let tactor;\n    if (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\n    else tactor = game.actors.get(lastArg.actorId);\n    const target = canvas.tokens.get(lastArg.tokenId)\n    if (tactor.data.data.traits.di.value.includes(\"poison\")) return\n    const flavor = `${CONFIG.DND5E.abilities[\"con\"]} DC${args[1]} Stinking Cloud`;\n    let saveRoll = (await tactor.rollAbilitySave(\"con\", { flavor }))?.total;\n    if(!saveRoll) return;\n\n    if (saveRoll < args[1]) {\n        ChatMessage.create({ content: `${token.name} spends its turn doing nothing` })\n    } else {\n        ChatMessage.create({ content: `${token.name} saves against Stinking Cloud` })\n    }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.muUKx4rkxJpln4vp"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"vLTe3P1kH02yBLlF"}
{"name":"ActiveEffect","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"//args[0] = token ID\n//args[1] = Name of Item in \"\" or update data\n//args[2] = \"add\", \"enable\", \"disable\" or \"remove\"\n(async ()=>{\nlet target = canvas.tokens.get(args[0]).actor;\nif ((args[2] === \"remove\") && (target.effects.entries.find(ef=> ef.data.label === args[1]))) {\nlet effect_id = await target.effects.entries.find(ef=> ef.data.label === args[1]).id;\nawait target.deleteEmbeddedDocuments(\"ActiveEffect\", [effect_id]);\n}\nif ((args[2] === \"disable\") && (target.effects.entries.find(ef=> ef.data.label === args[1]))) {\nlet effect_id = await target.effects.entries.find(ef=> ef.data.label === args[1]).id;    \nawait target.updateEmbeddedDocuments(\"ActiveEffect\", [{\"_id\": effect_id,  \"disabled\" : true}]);\n}\nif ((args[2] === \"enable\") && (target.effects.entries.find(ef=> ef.data.label === args[1]))) {\nlet effect_id = await target.effects.entries.find(ef=> ef.data.label === args[1]).id;\nawait target.updateEmbeddedDocuments(\"ActiveEffect\", [{\"_id\": effect_id,  \"disabled\" : false}]);\n}\nif (args[2] === \"add\") {\nlet effect_data = await args[1];\nawait target.createEmbeddedDocuments(\"ActiveEffect\", [effect_data]);\n}    \n})();\n//usage\n// let ActiveEffect = game.macros.getName(\"ActiveEffect\");\n// ActiveEffect.execute(target, \"Name of Item\", \"add\" or \"remove\");","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":true},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"hipAqZJuPgWHPn8K"}
{"name":"ADD-Cub-Condition","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/0%20add_effects%20-%20Copia.png","scope":"global","command":"let options = '';\ngame.cub.conditions.forEach((item) => {\n  options += `<option value=\"${item.name}\">\\n`;\n});\nlet content = `\n<form>\n  <div class=\"form-group\">\n    <label for=\"condition\">Condition:</label>\n    <input list=\"conditions\" id=\"condition\" name=\"condition\"/ autofocus>\n    <datalist id=\"conditions\">\n      ${options}\n    </datalist>\n  </div>\n</form>\n`\n\nnew Dialog({\n  title: `Select Condition`,\n  content: content,\n  buttons: {\n    yes: {\n      icon: \"<i class='fas fa-check'></i>\",\n      label: `Apply`,\n      callback: (html) => {\n        let condition = html.find('#condition').val();\n        if (!game.cub.conditions.some(el => el.name === condition)) {\n          return ui.notifications.info(\"Select a valid condition.\");\n        }\n\n        //apply the condition to selected tokens (0.6.6)\n        //game.cub.applyCondition(condition);\n\n    //apply the condition to the selected tokens (0.7.5)\n    game.cub.addCondition(condition);\n\n      }\n    },\n    no: {\n      icon: \"<i class='fas fa-times'></i>\",\n      label: `Cancel`\n    },\n  },\n  default: \"yes\"\n}).render(true);\n\n(async () => {\n  await new Promise(resolve => setTimeout(resolve, 20));\n  let input = $('#condition').focus();\n})();","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.RpuEJrkUjZIDqVU2"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"xMEDw05cZ4ApqMMA"}
{"name":"Add-TempHP","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/add_temp_hp.png","scope":"global","command":"//Add or subtract Temp HP. Will do math or rolls.\n//Preface with \"=\" to set to exactly that number\n/* Alt Use: */\n//Can be used wtihin entity link buttons. Anything but the first number is ignored.\n//\"->\" can be used to subtract the number of the next inline roll encountered\n//\"+>\" can be used to add the number of the next inline roll encountered\n//\"=>\" can be used to set to the number of the next inline roll encountered\n//Examples: (All are equivalent)\n//\t@Macro[Add Temp HP]{Add Temp HP ->}[[5+3]]\n//\t@Macro[Add Temp HP]{+8 THP}\n//\t@Macro[Add Temp HP]{Set to =>}[[@attributes.hp.temp + 3 + 5]]\n\nvar controlled = canvas.tokens.controlled.map(o => o.actor),\n\tinputText = false,\n\tchatMessage = game.messages.get(event.srcElement.closest('.message')?.getAttribute('data-message-id'));\nif (window.macroChain?.length || event.srcElement.nodeName == 'A')\n\tinputText = window.macroChain?.pop() || event.srcElement.textContent.trim();\n\nif (inputText) {\n\tif (inputText.indexOf('->') > -1)\n\t\tinputText = '-1 * (' + event.srcElement.nextElementSibling?.textContent.trim() + ')';\n\telse if (inputText.indexOf('+>') > -1)\n\t\tinputText = event.srcElement.nextElementSibling?.textContent.trim();\n\telse if (inputText.indexOf('=>') > -1)\n\t\tinputText = '=' + event.srcElement.nextElementSibling?.textContent.trim();\n\telse\n\t\tinputText = inputText.match(/([=-]?\\d)+/)?.[1];\n}\nif (!inputText) {\n\tlet d = new Dialog({\n\t\ttitle: 'How much Temp HP?',\n\t\tcontent: '<input name=\"temphp\" type=\"text\" class=\"temphp select-on-click\" placeholder=\"+Temp.\" title=\"Temporary Hit Points\" autofocus>',\n\t\tbuttons: {\n\t\t  ok: {\n\t\t\ticon: '',\n\t\t\tlabel: \"OK\",\n\t\t\tcallback: applyTHP\n\t\t  }\n\t\t},\n\t\tdefault: 'ok'\n\t  }, {width: 100});\n\tHooks.once('renderDialog', (a,inp) => inp[0].querySelector('input').focus());\n\td.render(true);\n}\nelse\n\tapplyTHP(null, inputText);\n\nfunction applyTHP(htm, fromButton=false) {\n\tcontrolled.forEach(selected => {\n\t\tlet change = 0, equal;\n\t\tif (fromButton || fromButton === '0')\n\t\t\tchange = fromButton;\n\t\telse\n\t\t\tchange = htm[0].querySelector('input').value;\n\t\tif (change.charAt(0) == '=') {\n\t\t\tequal = true;\n\t\t\tchange = change.slice(1);\n\t\t}\n\t\tlet parsed = parseInt((new Roll(change).roll()).total),\n\t\t\tdifference = Math.max(selected.data.data.attributes.hp.temp + parsed, 0);\n\t\tif (equal)\n\t\t\tselected.update({'data.attributes.hp.temp': parsed});\n\t\telse\n\t\t\tselected.update({'data.attributes.hp.temp': difference});\n\t});\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.rl0SGMTuz0vHiWpC"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"0hVCFcSQ7LaIwzD8"}
{"_id":"0hVCFcSQ7LaIwzD8","name":"Add-TempHP","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/add_temp_hp.png","scope":"global","command":"//Add or subtract Temp HP. Will do math or rolls.\n//Preface with \"=\" to set to exactly that number\n/* Alt Use: */\n//Can be used wtihin entity link buttons. Anything but the first number is ignored.\n//\"->\" can be used to subtract the number of the next inline roll encountered\n//\"+>\" can be used to add the number of the next inline roll encountered\n//\"=>\" can be used to set to the number of the next inline roll encountered\n//Examples: (All are equivalent)\n//\t@Macro[Add Temp HP]{Add Temp HP ->}[[5+3]]\n//\t@Macro[Add Temp HP]{+8 THP}\n//\t@Macro[Add Temp HP]{Set to =>}[[@attributes.hp.temp + 3 + 5]]\n\nvar controlled = canvas.tokens.controlled.map(o => o.actor),\n\tinputText = false,\n\tchatMessage = game.messages.get(event.srcElement.closest('.message')?.getAttribute('data-message-id'));\nif (window.macroChain?.length || event.srcElement.nodeName == 'A')\n\tinputText = window.macroChain?.pop() || event.srcElement.textContent.trim();\n\nif (inputText) {\n\tif (inputText.indexOf('->') > -1)\n\t\tinputText = '-1 * (' + event.srcElement.nextElementSibling?.textContent.trim() + ')';\n\telse if (inputText.indexOf('+>') > -1)\n\t\tinputText = event.srcElement.nextElementSibling?.textContent.trim();\n\telse if (inputText.indexOf('=>') > -1)\n\t\tinputText = '=' + event.srcElement.nextElementSibling?.textContent.trim();\n\telse\n\t\tinputText = inputText.match(/([=-]?\\d)+/)?.[1];\n}\nif (!inputText) {\n\tlet d = new Dialog({\n\t\ttitle: 'How much Temp HP?',\n\t\tcontent: '<input name=\"temphp\" type=\"text\" class=\"temphp select-on-click\" placeholder=\"+Temp.\" title=\"Temporary Hit Points\" autofocus>',\n\t\tbuttons: {\n\t\t  ok: {\n\t\t\ticon: '',\n\t\t\tlabel: \"OK\",\n\t\t\tcallback: applyTHP\n\t\t  }\n\t\t},\n\t\tdefault: 'ok'\n\t  }, {width: 100});\n\tHooks.once('renderDialog', (a,inp) => inp[0].querySelector('input').focus());\n\td.render(true);\n}\nelse\n\tapplyTHP(null, inputText);\n\nfunction applyTHP(htm, fromButton=false) {\n\tcontrolled.forEach(selected => {\n\t\tlet change = 0, equal;\n\t\tif (fromButton || fromButton === '0')\n\t\t\tchange = fromButton;\n\t\telse\n\t\t\tchange = htm[0].querySelector('input').value;\n\t\tif (change.charAt(0) == '=') {\n\t\t\tequal = true;\n\t\t\tchange = change.slice(1);\n\t\t}\n\t\tlet parsed = parseInt((new Roll(change).roll()).total),\n\t\t\tdifference = Math.max(selected.data.data.attributes.hp.temp + parsed, 0);\n\t\tif (equal)\n\t\t\tselected.update({'data.attributes.hp.temp': parsed});\n\t\telse\n\t\t\tselected.update({'data.attributes.hp.temp': difference});\n\t});\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.rl0SGMTuz0vHiWpC"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}}}
{"name":"AuraPossen","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\n[{\n    filterType: \"zapshadow\",\n    filterId: \"myUglyZapShadow\",\n    alphaTolerance: 0.50\n},\n{\n    filterType: \"xglow\",\n    filterId: \"myUglyGlow\",\n    auraType: 2,\n    color: 0x050505,\n    thickness: 2.7,\n    scale: 7,\n    time: 0,\n    auraIntensity: 5,\n    subAuraIntensity: 2,\n    threshold: 0.08,\n    discard: false,\n    animated:\n    {\n        time : \n        {  \n           active: true,\n           speed: 0.0012, \n           animType: \"move\" \n        },\n        auraIntensity:\n        {\n           active: true,\n           loopDuration: 3000, \n           animType: \"syncCosOscillation\", \n           val1:5, \n           val2:0\n        },\n        subAuraIntensity:\n        {\n           active: true,\n           loopDuration: 3000, \n           animType: \"syncCosOscillation\", \n           val1:2, \n           val2:0\n        },\n        color:\n        {\n           active: true,\n           loopDuration: 6000, \n           animType: \"syncColorOscillation\", \n           val1:0x050505, \n           val2:0x200000\n        },\n        threshold:\n        {\n           active: true,\n           loopDuration: 1500, \n           animType: \"syncCosOscillation\", \n           val1:0.02, \n           val2:0.50\n        }\n    }\n}];\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.ydY1XOCO4yIhunkj"},"combat-utility-belt":{"macroTrigger":""},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"27 - T03 - Ugly Villains Aura (xglow)","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"qho7SVuSqDKplZ6g"}
{"name":"Cub_Condition","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"// Add this Callback macro to your GM's hotbar and use Furnace mod to check \"Execute as GM\".\n// You should only pass the target id to this macro\n(async ()=>{\nlet target = canvas.tokens.get(args[0]);\nlet condition = args[1];\nlet state = args[2];\nif (state === \"remove\"){\n    await game.cub.removeCondition(condition, target, {warn: false});\n}\nif (state === \"add\"){\n    await game.cub.addCondition(condition, target, {warn: false});\n}\n})();","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":true},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"mYVeh3IuEhXWtxrc"}
{"name":"Display Attribute Lists for Selected Actor","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/book.svg","scope":"global","command":"ShowActorAttributeData(actor);","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.vIYlN91XcHeOY5KW"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"a0VdfIRRvwvY80fd"}
{"name":"Dodge-action","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/defensive-stance.jpg","scope":"global","command":"// requer uma condition CUB chamada Dodge com as flags adicionadas.\nif(!game.cub.hasCondition(\"Dodge\")) return game.cub.addCondition(\"Dodge\");\ngame.cub.removeCondition(\"Dodge\");","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.Tnx74XaZaMyuJXT0"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"loLEe53fEj2vHmuP"}
{"name":"DoTrapAttack","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/trap.png","scope":"global","command":"// Requires midi-qol to work at all\n// Rolls an attack from actor args[0] using item args[1] and display a token args[2]\nlet tactor = game.actors.entities.find(a => a.name === args[0])\nif (!tactor) return `/Whisper GM \"DoTrap: Target token ${args[0]} not found\"`\nlet item = tactor.items.find(i=>  i.name === args[1])\nif (!item) return `/Whisper GM \"DoTrap: Item ${args[1]} not found\"`\nlet oldTargets = game.user.targets;\ngame.user.targets = new Set().add(token);\nlet trapToken = canvas.tokens.placeables.find(t=>t.name === args[2]);\nif(trapToken.data.hidden) {\nnew MidiQOL.TrapWorkflow(tactor, item, [token], trapToken.center)\n//uncomment the next line if you use conditional visibility to hide traps\n//game.cub.removeAllConditions(trapToken);\nif (trapToken) await trapToken.update({\"hidden\" : false});\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"RXO1KHWtAmZ2eIzE"}
{"name":"FavoredFoe","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/plutonium/media/icon/spell/phb-hunters-mark.jpg","scope":"global","command":"const nome = \"FavoredFoe\"; // Troque MeuEfeito pelo nome exato do efeito que você quer ligar ou desligar.\n\nconst macroVersion = 'v0.3';\n\n/* Ativar/Desativar Efeito\nSource: https://raw.githubusercontent.com/brunocalado/mestre-digital/master/Foundry%20VTT/Macros/DnD%205e/ToogleAE.js\nIcon: \n*/\n//\n\nif (!actor) {\n  ui.notifications.warn(`Selecione um token!`); // get selected token \n} else {\n  main();\n}\n\nasync function main() {  \n  let effect = canvas.tokens.controlled[0].actor.effects.find(i => i.data.label === nome);\n  if (!effect) {\n    ui.notifications.warn(`Efeito não localizado!`); // get selected token \n  } else {\n    await effect.update({disabled: !effect.data.disabled});            \n    let mensagem = `O efeito <b>${nome}</b> foi ${effect.data.disabled?'<b style=\"color:red\">desativado!</b>':'<b style=\"color:green\">ativado!</b>'}</b>`;\n    let chatData = {\n      user: game.user._id,\n      speaker: ChatMessage.getSpeaker(),\n      content: mensagem\n    };  \n    ChatMessage.create(chatData, {});    \n    \n  }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"EEArlPl00LNxXVPv"}
{"name":"Fire Bolt","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/plutonium/media/icon/spell/phb-fire-bolt.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Fire Bolt\");","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"dnd5e":{"itemMacro":true},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"UoaapIFiQBOaN5PT"}
{"name":"FX- Delete filters on Selected","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/filter_delete.png","scope":"global","command":"// Delete all filters on the selected tokens/tiles\nTokenMagic.deleteFiltersOnSelected();","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"00 - A - Delete filters on Selected","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"core":{"sourceId":"Macro.k3nJVdOcsbMDVnrb"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"yqVFlzjFk6H3hcS1"}
{"name":"GM SearingSmite","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"//GM macro\n// Named = \"GM SearingSmite\"\nlet smiteTarget = canvas.tokens.get(args[1])\nif (args[0] === \"each\") {\n    const flavor = `${CONFIG.DND5E.abilities[\"con\"]} DC${args[3]} ${\"Searing Smite\"}`;\n    let saveRoll = (await smiteTarget.actor.rollAbilitySave(\"con\", {flavor})).total;\n    if (saveRoll < args[3]) {\n        let roll = new Roll(\"1d6\").roll().total;\n        let targets = new Set();\n        let saves = new Set();\n        targets.add(smiteTarget);\n        saves.add(targets);\n        MidiQOL.applyTokenDamage([{ damage: roll, type: \"fire\" }], roll, targets, [], saves);;\n    }\n    return;\n}\n\n\nif (args[0] === \"apply\") {\n    let effectData = {\n        changes: [\n            {\n                key: \"macro.execute\",\n                mode: 0,\n                priority: 20,\n                value: `\"GM SearingSmite\" @token null ${args[3]}`,\n            }\n        ],\n        label: \"Searing Smite DoT\",\n        icon: \"systems/dnd5e/icons/skills/yellow_19.jpg\",\n        duration: {\n            \"rounds\": args[2],\n        },\n        flags: {\n            dae: {\n                macroRepeat: \"startEveryTurn\"\n            }\n        }\n    }\n\n    smiteTarget.actor.createEmbeddedEntity(\"ActiveEffect\", effectData);\n}\n/*\nconst hookId = Hooks.on(\"updateCombat\", (combat, changed, options, userId) => {\n    if (!(\"turn\" in changed)) return;\n    if (combat.combatant.tokenId === smiteTarget.data._id && smiteTarget.actor.effects.find(i => i.data.label === \"Searing Smite DoT\")) {\n        let saveRoll = smiteTarget.actor.rollAbilitySave(\"con\");\n        if (saveRoll.total < args[2]) {\n            let roll = new Roll(\"1d6\").roll().total;\n            let targets = new Set();\n            let saves = new Set();\n            targets.add(smiteTarget);\n            saves.add(targets);\n            MidiQOL.applyTokenDamage([{ damage: roll, type: \"fire\" }], 10, targets, [], saves);;\n        }\n    }\n});\nsmiteTarget.setFlag(\"world\", \"SearingSmite\", {\n    hook: hookId,\n});\ngame.Gametime.doIn({ seconds: timeRemaining }, async () => {\n});*/","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":true},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"2g3LlcrN6SDNw9At"}
{"name":"Gold_Changer","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/gold.png","scope":"global","command":"//Money Give/Remover -> target necessary\n\n(()=>{\n\tlet targets = game.user.targets;\n\n\tlet targets_content =``;\n\n\tfor(let target of targets)\n\t{\n\t\ttargets_content += `<img src=${target.data.img} width=\"50\" height=\"50\">`\n\t}\n\n\tlet dialog_content = `\n\t<p></p>\n\t${targets_content}\n\t<div class = \"form-group\">\n\t\t<label for=\"pp\">Platnium<label>\n\t\t<input name=\"pp\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t\t<label for=\"gp\">Gold    <label>\n\t\t<input name=\"gp\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t\t<label for=\"ep\">Electrum<label>\n\t\t<input name=\"ep\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t\t<label for=\"sp\">Silver  <label>\n\t\t<input name=\"sp\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t\t<label for=\"cp\">Copper  <label>\n\t\t<input name=\"cp\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t</div>`;\n\n\tnew Dialog({\n\t\tcontent : dialog_content,\n\t\tbuttons : \n\t\t{\n\t\t\tOk : {icon : ``, label : `Change Money.`, callback : (html) => changeMoney(targets,html)}\n\t\t}\n\t}).render(true);\n})();\n\nasync function changeMoney(targets,html)\n{\n\tlet difference_money = {\n\t\tpp : parseInt(html.find('[name=pp]')[0].value),\n\t\tgp : parseInt(html.find('[name=gp]')[0].value),\n\t\tep : parseInt(html.find('[name=ep]')[0].value),\n\t\tsp : parseInt(html.find('[name=sp]')[0].value),\n\t\tcp : parseInt(html.find('[name=cp]')[0].value)\n\t}\n\n  //console.log(targets,update_money);\n  \n  //divide update_money based on # of targets\n  difference_money = divideValue(difference_money, targets.size);\n\n  console.log(difference_money);\n\n\tfor(let target of targets)\n\t{\n    let original_money = duplicate(target.actor.data.data.currency);\n    let update_money = changeValue(original_money,difference_money);    \n\n    console.log(target.actor.name)\n    console.log(original_money)\n    console.log(difference_money)\n    console.log(update_money);\n\n    await target.actor.update({\"data.currency\" : update_money});\n\t}\n}\n\nfunction changeValue(Original, Difference)\n{\n  let Update = {pp :0, gp:0, ep:0, sp :0, cp: 0};\n\n  for(let key in Original)\n  {\n    Update[key] = Original[key] + Difference[key];\n    if(Update[key] < 0)\n    {\n      switch(key)\n      {\n        case \"cp\" :\n          if (Update[\"sp\"] > 0)\n          {\n            Update[\"cp\"] += 10;\n            Update[\"sp\"] -= 1;\n          }\n          else if(Update[\"ep\"] > 0)\n          {\n            Update[\"cp\"] += 50;\n            Update[\"ep\"] -= 1;\n          }\n          else if(Update[\"gp\"] > 0)\n          {\n            Update[\"cp\"] += 100;\n            Update[\"gp\"] -= 1;\n          }\n          else if(Update[\"pp\"] > 0)\n          {\n            Update[\"cp\"] += 1000;\n            Update[\"pp\"] -= 1;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n          break;\n        case \"sp\" :\n          if (Update[\"ep\"] > 0)\n          {\n            Update[\"sp\"] += 5;\n            Update[\"ep\"] -= 1;\n          }\n          else if(Update[\"gp\"] > 0)\n          {\n            Update[\"sp\"] += 10;\n            Update[\"gp\"] -= 1;\n          }\n          else if(Update[\"pp\"] > 0)\n          {\n            Update[\"sp\"] += 100;\n            Update[\"pp\"] -= 1;\n          }\n          else if(Update[\"cp\"] > 9)\n          {\n            Update[\"sp\"] += 1;\n            Update[\"cp\"] -= 10;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n          break;\n        case \"ep\" :\n          if (Update[\"gp\"] > 0)\n          {\n            Update[\"ep\"] += 2;\n            Update[\"gp\"] -= 1;\n          }\n          else if(Update[\"pp\"] > 0)\n          {\n            Update[\"ep\"] += 20;\n            Update[\"pp\"] -= 1;\n          }\n          else if(Update[\"sp\"] > 4)\n          {\n            Update[\"ep\"] += 1;\n            Update[\"sp\"] -= 5;\n          }\n          else if(Update[\"cp\"] > 49)\n          {\n            Update[\"ep\"] += 1;\n            Update[\"cp\"] -= 50;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n          break;\n        case \"gp\" :\n          if (Update[\"pp\"] > 0)\n          {\n            Update[\"gp\"] += 10;\n            Update[\"pp\"] -= 1;\n          }\n          else if(Update[\"ep\"] > 1)\n          {\n            Update[\"gp\"] += 1;\n            Update[\"ep\"] -= 2;\n          }\n          else if(Update[\"sp\"] > 9)\n          {\n            Update[\"gp\"] += 1;\n            Update[\"sp\"] -= 10;\n          }\n          else if(Update[\"cp\"] > 99)\n          {\n            Update[\"gp\"] += 1;\n            Update[\"cp\"] -= 100;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n          break;\n        case \"pp\" :\n          if (Update[\"gp\"] > 9)\n          {\n            Update[\"pp\"] += 1;\n            Update[\"gp\"] -= 10;\n          }\n          else if(Update[\"ep\"] > 19)\n          {\n            Update[\"pp\"] += 1;\n            Update[\"ep\"] -= 20;\n          }\n          else if(Update[\"sp\"] > 99)\n          {\n            Update[\"pp\"] += 1;\n            Update[\"sp\"] -= 100;\n          }\n          else if(Update[\"cp\"] > 999)\n          {\n            Update[\"pp\"] += 1;\n            Update[\"cp\"] -= 1000;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n      }\n    }\n  }\n  return Update;\n}\n\nfunction divideValue(Object, Value)\n{\n  if(Value === 1) return Object;\n  let remainder = 0;\n  let Update = {pp :0, gp:0, ep:0, sp :0, cp: 0};\n\n  for(let key in Object)\n  {\n    Update[key] = Object[key] + remainder;\n    remainder = Object[key]%Value;\n    if(Update[key] > 0) Update[key] = Math.floor(Update[key]/Value);\n    if(Update[key] < 0) Update[key] = Math.ceil(Update[key]/Value);\n    if(remainder !== 0)\n    {\n      if(key === \"ep\")\n      {remainder *= 5;}\n      else if (key === \"gp\")\n      {remainder *= 2;}\n      else\n      {remainder *= 10;}\n    }\n  }\n  console.log(`There was ${remainder/10} cp left over.`);\n  return Update;\n}\n\nfunction x(Original, edit_key)\n{\n  let Update = duplicate(Original);\n  for(let key in Update)\n  {\n    if(key === edit_key)\n    {\n\n    }\n  }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro ","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.9ueMmrsGlKkx6kV8"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"0ze1BiNUSZ4dAsL3"}
{"_id":"0ze1BiNUSZ4dAsL3","name":"Gold_Changer","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/gold.png","scope":"global","command":"//Money Give/Remover -> target necessary\n\n(()=>{\n\tlet targets = game.user.targets;\n\n\tlet targets_content =``;\n\n\tfor(let target of targets)\n\t{\n\t\ttargets_content += `<img src=${target.data.img} width=\"50\" height=\"50\">`\n\t}\n\n\tlet dialog_content = `\n\t<p></p>\n\t${targets_content}\n\t<div class = \"form-group\">\n\t\t<label for=\"pp\">Platnium<label>\n\t\t<input name=\"pp\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t\t<label for=\"gp\">Gold    <label>\n\t\t<input name=\"gp\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t\t<label for=\"ep\">Electrum<label>\n\t\t<input name=\"ep\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t\t<label for=\"sp\">Silver  <label>\n\t\t<input name=\"sp\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t\t<label for=\"cp\">Copper  <label>\n\t\t<input name=\"cp\" type =\"number\" value=\"0\" min=\"-999\" max=\"999\"><br>\n\t</div>`;\n\n\tnew Dialog({\n\t\tcontent : dialog_content,\n\t\tbuttons : \n\t\t{\n\t\t\tOk : {icon : ``, label : `Change Money.`, callback : (html) => changeMoney(targets,html)}\n\t\t}\n\t}).render(true);\n})();\n\nasync function changeMoney(targets,html)\n{\n\tlet difference_money = {\n\t\tpp : parseInt(html.find('[name=pp]')[0].value),\n\t\tgp : parseInt(html.find('[name=gp]')[0].value),\n\t\tep : parseInt(html.find('[name=ep]')[0].value),\n\t\tsp : parseInt(html.find('[name=sp]')[0].value),\n\t\tcp : parseInt(html.find('[name=cp]')[0].value)\n\t}\n\n  //console.log(targets,update_money);\n  \n  //divide update_money based on # of targets\n  difference_money = divideValue(difference_money, targets.size);\n\n  console.log(difference_money);\n\n\tfor(let target of targets)\n\t{\n    let original_money = duplicate(target.actor.data.data.currency);\n    let update_money = changeValue(original_money,difference_money);    \n\n    console.log(target.actor.name)\n    console.log(original_money)\n    console.log(difference_money)\n    console.log(update_money);\n\n    await target.actor.update({\"data.currency\" : update_money});\n\t}\n}\n\nfunction changeValue(Original, Difference)\n{\n  let Update = {pp :0, gp:0, ep:0, sp :0, cp: 0};\n\n  for(let key in Original)\n  {\n    Update[key] = Original[key] + Difference[key];\n    if(Update[key] < 0)\n    {\n      switch(key)\n      {\n        case \"cp\" :\n          if (Update[\"sp\"] > 0)\n          {\n            Update[\"cp\"] += 10;\n            Update[\"sp\"] -= 1;\n          }\n          else if(Update[\"ep\"] > 0)\n          {\n            Update[\"cp\"] += 50;\n            Update[\"ep\"] -= 1;\n          }\n          else if(Update[\"gp\"] > 0)\n          {\n            Update[\"cp\"] += 100;\n            Update[\"gp\"] -= 1;\n          }\n          else if(Update[\"pp\"] > 0)\n          {\n            Update[\"cp\"] += 1000;\n            Update[\"pp\"] -= 1;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n          break;\n        case \"sp\" :\n          if (Update[\"ep\"] > 0)\n          {\n            Update[\"sp\"] += 5;\n            Update[\"ep\"] -= 1;\n          }\n          else if(Update[\"gp\"] > 0)\n          {\n            Update[\"sp\"] += 10;\n            Update[\"gp\"] -= 1;\n          }\n          else if(Update[\"pp\"] > 0)\n          {\n            Update[\"sp\"] += 100;\n            Update[\"pp\"] -= 1;\n          }\n          else if(Update[\"cp\"] > 9)\n          {\n            Update[\"sp\"] += 1;\n            Update[\"cp\"] -= 10;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n          break;\n        case \"ep\" :\n          if (Update[\"gp\"] > 0)\n          {\n            Update[\"ep\"] += 2;\n            Update[\"gp\"] -= 1;\n          }\n          else if(Update[\"pp\"] > 0)\n          {\n            Update[\"ep\"] += 20;\n            Update[\"pp\"] -= 1;\n          }\n          else if(Update[\"sp\"] > 4)\n          {\n            Update[\"ep\"] += 1;\n            Update[\"sp\"] -= 5;\n          }\n          else if(Update[\"cp\"] > 49)\n          {\n            Update[\"ep\"] += 1;\n            Update[\"cp\"] -= 50;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n          break;\n        case \"gp\" :\n          if (Update[\"pp\"] > 0)\n          {\n            Update[\"gp\"] += 10;\n            Update[\"pp\"] -= 1;\n          }\n          else if(Update[\"ep\"] > 1)\n          {\n            Update[\"gp\"] += 1;\n            Update[\"ep\"] -= 2;\n          }\n          else if(Update[\"sp\"] > 9)\n          {\n            Update[\"gp\"] += 1;\n            Update[\"sp\"] -= 10;\n          }\n          else if(Update[\"cp\"] > 99)\n          {\n            Update[\"gp\"] += 1;\n            Update[\"cp\"] -= 100;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n          break;\n        case \"pp\" :\n          if (Update[\"gp\"] > 9)\n          {\n            Update[\"pp\"] += 1;\n            Update[\"gp\"] -= 10;\n          }\n          else if(Update[\"ep\"] > 19)\n          {\n            Update[\"pp\"] += 1;\n            Update[\"ep\"] -= 20;\n          }\n          else if(Update[\"sp\"] > 99)\n          {\n            Update[\"pp\"] += 1;\n            Update[\"sp\"] -= 100;\n          }\n          else if(Update[\"cp\"] > 999)\n          {\n            Update[\"pp\"] += 1;\n            Update[\"cp\"] -= 1000;\n          }else{\n            throw new Error(`Not enough money to do that.`);\n          }\n          Update = changeValue(Update, {pp :0, gp:0, ep:0, sp :0, cp: 0});\n      }\n    }\n  }\n  return Update;\n}\n\nfunction divideValue(Object, Value)\n{\n  if(Value === 1) return Object;\n  let remainder = 0;\n  let Update = {pp :0, gp:0, ep:0, sp :0, cp: 0};\n\n  for(let key in Object)\n  {\n    Update[key] = Object[key] + remainder;\n    remainder = Object[key]%Value;\n    if(Update[key] > 0) Update[key] = Math.floor(Update[key]/Value);\n    if(Update[key] < 0) Update[key] = Math.ceil(Update[key]/Value);\n    if(remainder !== 0)\n    {\n      if(key === \"ep\")\n      {remainder *= 5;}\n      else if (key === \"gp\")\n      {remainder *= 2;}\n      else\n      {remainder *= 10;}\n    }\n  }\n  console.log(`There was ${remainder/10} cp left over.`);\n  return Update;\n}\n\nfunction x(Original, edit_key)\n{\n  let Update = duplicate(Original);\n  for(let key in Update)\n  {\n    if(key === edit_key)\n    {\n\n    }\n  }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro ","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.9ueMmrsGlKkx6kV8"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}}}
{"name":"Macro_Searing_Strike","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"//DAE effects:\n//  1: macro execute, Effect Value = (optional name of macro, leave blank for item macro) time-of-duration @attributes.spelldc @item.level\n//  2: data.bonuses.mwak.damage, value = blank\n// Special Expiry set to 1 hit\n// Target - Self, clear all spell effects in the Action field including any saves or damage\n\n// Create 2 macros, one for the client and one for the GM side, give the GM macro \"Run as GM\" permissions from furnace\n\n//Client side macro, to be called by the DAE effect\nconst lastArg = args[args.length - 1];\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nelse tactor = game.actors.get(lastArg.actorId);\n\nif(args[0] === \"on\"){\n    let effect =  tactor.effects.find(i => i.data.label === \"Searing Smite\");\n    let changes = effect.data.changes;\n    changes[1].value = `${args[3]}d6[fire]`\n    await effect.update({changes});\n}\n\nif (args[0] === \"off\") {\n    let timeRemaining = lastArg.efData.duration.rounds - (game.combats.active.current.round - lastArg.efData.duration.startRound)\n    let targets = game.user.targets\n    const GMmacro = game.macros.getName(\"GM SearingSmite\")\n    for (let smiteTarget of targets) {\n        GMmacro.execute(\"apply\", smiteTarget.id, timeRemaining, args[2])\n    }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"yzbfNTD4sU7Ju8FT"}
{"name":"New Macro","type":"chat","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"ovi30YUB9idwFwSW"}
{"name":"Rage-Macro-Liga/Desliga","type":"script","author":"05k4ub2VgC3VLxAg","img":"systems/dnd5e/icons/skills/red_10.jpg","scope":"global","command":"//\t\tDISCLAIMER:\t\tThis macro is an evolved version of the original D&D 5e Rage Macro masterwork written by Felix#6196.\n//\t\t\t\t\t\tNorc#5108 is now maintaining this macro along with continued support from Felix.\n//\n//\n//\t\tUPDATES:\t\t1.\tFixed errors resulting from declarations of \"actor\" and \"token\" in a script macro. \n//\t\t\t\t\t\t\tAdded automatic Totem Spirit: Bear detection and resistance application \n//\t\t\t\t\t\t\tAdded error messages for trying to rage with no token or no barbarian selected\n//\t\t\t\t\t\t2.\t(Felix) Added resource/usage deduction and errors (re-added after accidentally overwriting the addition)\n//\t\t\t\t\t\t\tFixed rage damage at level 8\n//\t\t\t\t\t\t3.\t(2020/05/30) \"Version 2.0\" \t\n//\t\t\t\t\t\t\tImplemented Felix's idea to use global melee weapon attack bonus instead of modifying items\n//\t\t\t\t\t\t\tImproved Rage icon toggling to be more reliable\n//\t\t\t\t\t\t\tRemoved code from the resource management that created dependency on The Furnace Advanced Macros\n//\t\t\t\t\t\t\tImplemented Felix's fix for issue where new resistances and rage uses were not saving properly\n//\t\t\t\t\t\t\tFixed rage damage formula again...\n//\t\t\t\t\t\t\tAdded basic support for non-strength Based barbarians (Dex, Hexblade)\n//\t\t\t\t\t\t\tAdded optional ability to toggle the icon and name of the macro itself based on current raging state.\n//\t\t\t\t\t\t4.\t(2020/06/04) \n//\t\t\t\t\t\t\tFixed bug with experimental macro name/icon toggle only by renaming \"actor\" and \"token\"\n//\t\t\t\t\t\t\tAdded basic localization support to allow searching for translated class features\n//\t\t\t\t\t\t5.\t(2020/06/10)\n//\t\t\t\t\t\t\tRework to rage damage logic under the hood for edge case (other changes to bonus damage mid-combat) \n//\t\t\t\t\t\t\tRemoved logic that was causing multiple character sheets to open in some cases\n//\t\t\t\t\t\t\tEnhanced localization support\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!   Bonus Tip 1: \t\tOptional Rage Resource Consumption\n//!!!\tTo automatically use and track Rage, you must have a resource exactly named \"Rage\" on your character sheet. This text can be changed\n//!!!\tby altering the value for \"rageResourceName\" in the LOCALIZATION SUPPORT section below).\n//!!!\tNote: \tImporting via VTTA Beyond Integration uses this text already. The macro can then automatically detect the Rage resource.\n//!!!\n//!!!\tBonus Tip 2: \t\tBear Totem Spirit Barbs\n//!!!\tIf you chose the Spirit Seeker Primal path, and at level 3 you chose the Bear Totem Spirit (resistance to all non-psychic damage), \n//!!!\tin your 5E character sheet, double-check that the name of your Totem Spirit feature to EXACTLY \"Totem Spirit: Bear\". This text can be\n//!!!\tchanged by altering the value for \"bearTotemFeatureName\" in the LOCALIZATION SUPPORT section below).\n//!!!\tNote: \tImporting via VTTA Beyond Integration uses this text already. The macro then automatically adds the extra \n//!!!\t\t\tBear Totem Spirit resistances.\n//!!!\n//!!!\tBonus Tip 3: \t\tThrown Weapons\n//!!!\tWhen a barb throws a weapon using strength, typically a javelin but also possibly a dagger, dart, sword, bar table etc, the rage bonus\n//!!!\tshould not be added because it is a ranged attack. However, D&D5E calls javelins and daggers Melee Weapons, because technically they\n//!!!\tare both. To solve this issue, if you always throw the weapon, click the weapon's details and change the attack type to \"Ranged Weapon\n//!!!\tAttack\" in the Action Type dropdown. If you want, you can add a second copy of the item (with no weight/quantity) to use for meleeing.\n//!!!\n//!!!\tBonus Tip 4: \t\tThe Rage Condition\n//!!!\tIf you use the Combat Utility Belt module's Condition Lab, try adding a condition called \"Raging\" with the same icon\n//!!!\tas the optional rage icon overlay, 'icons/svg/explosion.svg' by default.  See EXPERIMENTAL MACRO ICON/NAME TOGGLE section below.\n//!!!\n//!!!\tBonus Tip 5: \t\tObsidian Sheet Compatibility\n//!!!\tIf using Obsidian module, try replacing \"Barbarian\" with \"brb\" as the barbClassName value in LOCALIZATION SUPPORT below.\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL TOKEN ICON-\tOn by default. If a path to a rage icon is defined, it displays like a condition on the raging barbarian.\n//!!!\t\t\t\t\t\t\tTo use a different icon, manually change the filepath below or leave it empty ('') to disable the effect.\n//!!!\nconst rageIconPath = 'icons/svg/explosion.svg';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL RESOURCE DEDUCTION \tOn by default. First option automatically subtracts from the Rage Resource if enabled.\n//!!!\t\t\t\t\t\t\t\t\tSecond option prevents raging if no Rage resource is left. Set to false if you do not want this.\n\n\t\t\tconst deductResource = true;\n\t\t\tconst preventNegativeResource = true;\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL NON-STRENGTH BARBARIAN SUPPORT\t\tONLY override to FALSE if your barbarian does not use Strength to make melee attacks\n//!!!\t\t\t\t\t\t\t\t\t\t\t\tand therefore does not get the Rage bonus to melee weapon attack damage.\n//!!!\n\t\t\tconst strAttacks = true;\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tEXPERIMENTAL MACRO ICON/NAME TOGGLE\t\tIf enabled, the macro icon and name toggles based on the barbarian's rage state.\n//!!!\t\t\t\t\t\t\t\t\t\t\tCAUTIONS: \t1. \tThis feature is off by default and is intended for ADVANCED USERS ONLY.\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t2. \tRequires configuration using \"The Furnace\" module for a player to run!\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tThe GM needs to grant The Furnace's \"Run as GM\" permission for this macro.\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t3. \tWorks best with only one barbarian using this feature at a time.\n\n\t\t\t//To auto-toggle the macro's icon/name, override toggleMacro to true below.\n\t\t\tconst toggleMacro = false;\n\n\t\t\t//To use a different icon, manually change the filepath here\n\t\t\tconst stopRageIconPath = 'icons/svg/unconscious.svg';\n\n\t\t\t//You must update the following constant to this macro's exact name for the macro icon toggling to work.\n\t\t\tconst rageMacroName = 'Rage';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//declarations\nlet barb = '';\nlet chatMsg = '';\nlet bear = '';\nlet noRage = false;\nlet rageDmgAdded = false;\nlet toggleResult = false;\nlet macroActor = actor;\nlet macroToken = token;\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tLOCALIZATION SUPPORT\t\t\t\tSets names of D&D5E features as constants instead of hardcoding to allow easier translation.\n//!!!\t\t\t\t\t\t\t\t\t\tSets error messages and flavor text as constants also for easier translation.\n//!!!\n\t\t\t//MUST MATCH VALUES IN CHARACTER SHEET (if present)\n\t\t\tconst barbClassName = 'Barbarian';\n\t\t\tconst rageResourceName = 'Rage';\n\t\t\tconst bearTotemFeatureName = 'Totem Spirit: Bear';\n\n\t\t\t//All remaining values may be changed freely\n\n\t\t\t//Rage chat message flavor text. Actor's name appears immediately before these two strings in the message.\n\t\t\tconst rageMsg = ' is RAAAAAGING!'\n\t\t\tconst endRageMsg =  ' is no longer raging.';\n\n\t\t\t//error and warning messages\n\t\t\tconst errorSelectBarbarian = 'Please select a single barbarian token.';\n\t\t\tconst errorNoRage = ' does not have any rage left, time for a long rest!';\n\t\t\tconst warnMacroNotFound = ' is not a valid macro name, please fix. Rage toggle successful but unable to alter macro.';\n\t\t\tconst errorSelectToken = 'Please select a token.';\n\t\t\tconst errorFailRevert = 'Failed to revert global melee weapon attack bonus, please check manually.';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n\n//main\n//check to see if Actor exists and is a barbarian\nif (macroActor !== undefined && macroActor !== null) {\n\n\t// get the barbarian class item\n\tbarb = macroActor.items.find(i => i.name === `${barbClassName}`);\n\tif (barb == undefined) {\n\t\tui.notifications.warn(`${errorSelectBarbarian}`);\n\t}\n\tif (barb !== undefined && barb !== null) {\n\t\tchatMsg = `${macroActor.name} + rageMsg`;\n\t\tlet enabled = false;\n\t\t// Store the state of the rage toggle flags that indicate if rage is active or not\n\t\tif (macroActor.data.flags.rageMacro !== null && macroActor.data.flags.rageMacro !== undefined) {\n\t\t\tenabled = true;\n\t\t\t\t// Store whether there is also a rage damage bonus currently active\n\t\t\t\tif (macroActor.data.flags.rageMacro[\"rageDmgAdded\"] == true) {\n\t\t\t\t\trageDmgAdded = true;\n\t\t\t\t}\n\t\t}\n\n\t\t//Calculate rage value for use in damage reversion and application\n\t\t// Determining the barbarian level\n\t\tlet barblvl = barb.data.data.levels;\n\n\t\t// Formula to determine the rage bonus damage depending on barbarian level\n\t\tlet lvlCorrection =  barblvl === 16 || barblvl === 17 ? 1 : 0;\n\t\tlet rageDmg = 2 + Math.floor(barblvl / 9) + lvlCorrection;\n\t\tlet dmg = JSON.parse(JSON.stringify(macroActor.data.data.bonuses.mwak.damage));\n\n\t\t// if rage is active, disable it\n\t\tif (enabled) {\n\t\t\tchatMsg = `${macroActor.name} ${endRageMsg}`;\n\t\t\t// reset resistances and melee weapon attack bonus\n\t\t\tlet obj = {};\n\t\t\tobj['flags.rageMacro'] = null;\n\t\t\t//revert damage resistances\n\t\t\tobj['data.traits.dr'] = macroActor.data.flags.rageMacro.oldResistances;\n\n\t\t\t//carefully revert rage global mwak damage bonus to original value, if that bonus is active\n\t\t\t//eventually want to add support so only last instance found is replaced.\n\t\t\tif(rageDmgAdded) {\n\t\t\t\tif (dmg == rageDmg || dmg == null || dmg == undefined || dmg == '' || dmg == 0){\n\t\t\t\t\tconsole.log('Removing simple rage damage');\n\t\t\t\t\tobj['data.bonuses.mwak.damage']='';\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log('Removing complex rage damage');\n\t\t\t\t\tlet patt = `\\\\s\\\\+\\\\s${rageDmg}($|[^0123456789dkrxcm(@{])`;\n\t\t\t\t\tlet result = dmg.search(patt);\n\t\t\t\t\tif (result !== -1) {\n\t\t\t\t\t\tlet len = ('' + rageDmg).length;\n\t\t\t\t\t\tlet origDmg = duplicate(dmg);\n\t\t\t\t\t\tlet firstHalfDmg = duplicate(dmg).substring(0,result);\n\t\t\t\t\t\t//Test String: 2d6 + 2 + 2d6\n\t\t\t\t\t\tlet lastHalfDmg = duplicate(dmg).substring(result+3+len, origDmg.length);\n\t\t\t\t\t\tdmg = `${firstHalfDmg}${lastHalfDmg}`;\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage']=dmg;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tui.notifications.error(`${errorFailRevert}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tmacroActor.update(obj);\n\n\t\t// if rage is disabled, enable it\n\t\t} else {\n\t\t\tif (deductResource) {\n\t\t\t\tlet hasAvailableResource = false;\n\t\t\t\tlet newResources = duplicate(macroActor.data.data.resources)\n\t\t\t\tlet obj = {}\n\t\t\t\t// Look for Resources under the Core macroActor data\n\t\t\t\tlet resourceKey = Object.keys(macroActor.data.data.resources).filter(k => macroActor.data.data.resources[k].label === `${rageResourceName}`).shift();\n\t\t\t\tif (resourceKey && (macroActor.data.data.resources[resourceKey].value > 0 || !preventNegativeResource)) {\n\t\t\t\t\thasAvailableResource = true;\n\t\t\t\t\tnewResources[resourceKey].value--;\n\t\t\t\t\tobj['data.resources'] = newResources \n\t\t\t\t\tmacroActor.update(obj);\n\t\t\t\t}\n\t\t\t\tif (!hasAvailableResource) {\n\t\t\t\t\tui.notifications.error(`${macroActor.name} ${errorNoRage}`);\n\t\t\t\t\tnoRage=true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//activate rage if there is rage available, or if it is okay to rage with 0 resources\n\t\t\tif (!noRage) {\n\t\t\t\tchatMsg = `${macroActor.name} ${rageMsg}`;\n\t\t\t\t// update resistance\n\t\t\t\tlet obj = {};\n\t\t\t\t// storing old resistances in flags to restore later\n\t\t\t\tobj['flags.rageMacro.enabled'] = true;\n\t\t\t\tobj['flags.rageMacro.oldResistances'] = JSON.parse(JSON.stringify(macroActor.data.data.traits.dr));\n\t\t\t\t// add bludgeoning, piercing and slashing resistance\n\t\t\t\tlet newResistance = duplicate(macroActor.data.data.traits.dr);\n\t\t\t\tif (newResistance.value.indexOf('bludgeoning') === -1) newResistance.value.push('bludgeoning');\n\t\t\t\tif (newResistance.value.indexOf('piercing') === -1) newResistance.value.push('piercing');\n\t\t\t\tif (newResistance.value.indexOf('slashing') === -1) newResistance.value.push('slashing');\n\t\t\t\t//If bear totem, add bear totem resistances.\n\t\t\t\tbear = macroActor.items.find(i => i.name === `${bearTotemFeatureName}`)\n\t\t\t\tif (bear !== undefined && bear!== null) {\n\t\t\t\t\tif (newResistance.value.indexOf('acid') === -1) newResistance.value.push('acid');\n\t\t\t\t\tif (newResistance.value.indexOf('cold') === -1) newResistance.value.push('cold');\n\t\t\t\t\tif (newResistance.value.indexOf('fire') === -1) newResistance.value.push('fire');\n\t\t\t\t\tif (newResistance.value.indexOf('force') === -1) newResistance.value.push('force');\n\t\t\t\t\tif (newResistance.value.indexOf('lightning') === -1) newResistance.value.push('lightning');\n\t\t\t\t\tif (newResistance.value.indexOf('necrotic') === -1) newResistance.value.push('necrotic');\n\t\t\t\t\tif (newResistance.value.indexOf('poison') === -1) newResistance.value.push('poison');\n\t\t\t\t\tif (newResistance.value.indexOf('radiant') === -1) newResistance.value.push('radiant');\n\t\t\t\t\tif (newResistance.value.indexOf('thunder') === -1) newResistance.value.push('thunder');\n\t\t\t\t}\n\t\t\t\tobj['data.traits.dr'] = newResistance;\n\t\t\t\tmacroActor.update(obj);\n\n\t\t\t\t// For Strength barbarians, update global melee weapon attack bonus to include rage bonus\n\t\t\t\tif (strAttacks) {\n\t\t\t\t\tobj['flags.rageMacro.rageDmgAdded'] = true;\n\t\t\t\t\t// Preserve old mwak damage bonus if there was one, just in case\n\t\t\t\t\tobj['flags.rageMacro.oldDmg'] = JSON.parse(JSON.stringify(dmg));\n\t\t\t\t\t//actually add the bonus rage damage to the previous bonus damage\n\t\t\t\t\t//respect roll formulas by doing string addition if value is already present.\n\t\t\t\t\tif (dmg == null || dmg == undefined || dmg == 0 || dmg == '') {\n\t\t\t\t\t\tconsole.log('Adding simple rage damage');\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage'] = rageDmg;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log('Adding complex rage damage');\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage'] = `${dmg} + ${rageDmg}`;\n\t\t\t\t\t}\n\t\t\t\t\tmacroActor.update(obj);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!noRage) {\n\t\t\t// toggle rage icon, if rage path is defined above\n\t\t\t(async () => { \n\t\t\t\ttoggleResult = await macroToken.toggleEffect(rageIconPath);\n\t\t\t\tif (toggleResult == enabled) macroToken.toggleEffect(rageIconPath);  \n\t\t\t})();\n\t\t\t\n\t\t\t//toggle macro icon and name, if macro name is correct and stop rage icon path is defined\n\t\t\tlet rageMacro = game.macros.getName(rageMacroName);\n\t\t\t\t//check for name of macro in its \"off\" form\n\t\t\t\tif (rageMacro == null || rageMacro == undefined) {\n\t\t\t\t\trageMacro = game.macros.getName('Stop ' + rageMacroName);\n\t\t\t\t}\n\t\t\tlet obj = {};\n\t\t\tif ( (rageMacro !== null && rageMacro !== undefined) && toggleMacro == true && \n\t\t\t\t\t+ (stopRageIconPath !== null && stopRageIconPath !== undefined && stopRageIconPath !== '') ) {\n\t\t\t\tif (enabled) {\n\t\t\t\t  obj['img'] = rageIconPath;\n\t\t\t\t  obj['name'] = rageMacroName;\n\t\t\t\t} else {\n\t\t\t\t  obj['img'] = stopRageIconPath;\n\t\t\t\t  obj['name'] = 'Stop ' + rageMacroName;\n\t\t\t\t}\n\t\t\t\trageMacro.update(obj);\n\t\t\t} else {\n\t\t\tif (toggleMacro == true) ui.notifications.warn(`${rageMacroName} ${warnMacroNotFound}`);\n\t\t\t}\n\t\t}\n\t}\n} else ui.notifications.warn(errorSelectToken);\n// write to chat if needed:\nif (chatMsg !== '') {\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\tspeaker: ChatMessage.getSpeaker(),\n\t\tcontent: chatMsg\n\t};\n\tChatMessage.create(chatData, {});\n}\n\nif (token)\n  MacroMarker.toggle(this, { entity: token });","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"systems/dnd5e/icons/skills/red_10.jpg","tooltip":"Rage-Macro","colour":"#ff6600","trigger":""},"markers":{"markers":{"jv8ZYVc1mcpm4svY":true},"type":"Token"}},"combat-utility-belt":{"macroTrigger":""},"core":{"sourceId":"Macro.CgAyK40KyztIirYa"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"E3xFeG0efsBcIWfe"}
{"_id":"E3xFeG0efsBcIWfe","name":"Rage-Macro-Liga/Desliga","type":"script","author":"UMhia8n0PiFluoTS","img":"systems/dnd5e/icons/skills/red_10.jpg","scope":"global","command":"//\t\tDISCLAIMER:\t\tThis macro is an evolved version of the original D&D 5e Rage Macro masterwork written by Felix#6196.\n//\t\t\t\t\t\tNorc#5108 is now maintaining this macro along with continued support from Felix.\n//\n//\n//\t\tUPDATES:\t\t1.\tFixed errors resulting from declarations of \"actor\" and \"token\" in a script macro. \n//\t\t\t\t\t\t\tAdded automatic Totem Spirit: Bear detection and resistance application \n//\t\t\t\t\t\t\tAdded error messages for trying to rage with no token or no barbarian selected\n//\t\t\t\t\t\t2.\t(Felix) Added resource/usage deduction and errors (re-added after accidentally overwriting the addition)\n//\t\t\t\t\t\t\tFixed rage damage at level 8\n//\t\t\t\t\t\t3.\t(2020/05/30) \"Version 2.0\" \t\n//\t\t\t\t\t\t\tImplemented Felix's idea to use global melee weapon attack bonus instead of modifying items\n//\t\t\t\t\t\t\tImproved Rage icon toggling to be more reliable\n//\t\t\t\t\t\t\tRemoved code from the resource management that created dependency on The Furnace Advanced Macros\n//\t\t\t\t\t\t\tImplemented Felix's fix for issue where new resistances and rage uses were not saving properly\n//\t\t\t\t\t\t\tFixed rage damage formula again...\n//\t\t\t\t\t\t\tAdded basic support for non-strength Based barbarians (Dex, Hexblade)\n//\t\t\t\t\t\t\tAdded optional ability to toggle the icon and name of the macro itself based on current raging state.\n//\t\t\t\t\t\t4.\t(2020/06/04) \n//\t\t\t\t\t\t\tFixed bug with experimental macro name/icon toggle only by renaming \"actor\" and \"token\"\n//\t\t\t\t\t\t\tAdded basic localization support to allow searching for translated class features\n//\t\t\t\t\t\t5.\t(2020/06/10)\n//\t\t\t\t\t\t\tRework to rage damage logic under the hood for edge case (other changes to bonus damage mid-combat) \n//\t\t\t\t\t\t\tRemoved logic that was causing multiple character sheets to open in some cases\n//\t\t\t\t\t\t\tEnhanced localization support\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!   Bonus Tip 1: \t\tOptional Rage Resource Consumption\n//!!!\tTo automatically use and track Rage, you must have a resource exactly named \"Rage\" on your character sheet. This text can be changed\n//!!!\tby altering the value for \"rageResourceName\" in the LOCALIZATION SUPPORT section below).\n//!!!\tNote: \tImporting via VTTA Beyond Integration uses this text already. The macro can then automatically detect the Rage resource.\n//!!!\n//!!!\tBonus Tip 2: \t\tBear Totem Spirit Barbs\n//!!!\tIf you chose the Spirit Seeker Primal path, and at level 3 you chose the Bear Totem Spirit (resistance to all non-psychic damage), \n//!!!\tin your 5E character sheet, double-check that the name of your Totem Spirit feature to EXACTLY \"Totem Spirit: Bear\". This text can be\n//!!!\tchanged by altering the value for \"bearTotemFeatureName\" in the LOCALIZATION SUPPORT section below).\n//!!!\tNote: \tImporting via VTTA Beyond Integration uses this text already. The macro then automatically adds the extra \n//!!!\t\t\tBear Totem Spirit resistances.\n//!!!\n//!!!\tBonus Tip 3: \t\tThrown Weapons\n//!!!\tWhen a barb throws a weapon using strength, typically a javelin but also possibly a dagger, dart, sword, bar table etc, the rage bonus\n//!!!\tshould not be added because it is a ranged attack. However, D&D5E calls javelins and daggers Melee Weapons, because technically they\n//!!!\tare both. To solve this issue, if you always throw the weapon, click the weapon's details and change the attack type to \"Ranged Weapon\n//!!!\tAttack\" in the Action Type dropdown. If you want, you can add a second copy of the item (with no weight/quantity) to use for meleeing.\n//!!!\n//!!!\tBonus Tip 4: \t\tThe Rage Condition\n//!!!\tIf you use the Combat Utility Belt module's Condition Lab, try adding a condition called \"Raging\" with the same icon\n//!!!\tas the optional rage icon overlay, 'icons/svg/explosion.svg' by default.  See EXPERIMENTAL MACRO ICON/NAME TOGGLE section below.\n//!!!\n//!!!\tBonus Tip 5: \t\tObsidian Sheet Compatibility\n//!!!\tIf using Obsidian module, try replacing \"Barbarian\" with \"brb\" as the barbClassName value in LOCALIZATION SUPPORT below.\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL TOKEN ICON-\tOn by default. If a path to a rage icon is defined, it displays like a condition on the raging barbarian.\n//!!!\t\t\t\t\t\t\tTo use a different icon, manually change the filepath below or leave it empty ('') to disable the effect.\n//!!!\nconst rageIconPath = 'icons/svg/explosion.svg';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL RESOURCE DEDUCTION \tOn by default. First option automatically subtracts from the Rage Resource if enabled.\n//!!!\t\t\t\t\t\t\t\t\tSecond option prevents raging if no Rage resource is left. Set to false if you do not want this.\n\n\t\t\tconst deductResource = true;\n\t\t\tconst preventNegativeResource = true;\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL NON-STRENGTH BARBARIAN SUPPORT\t\tONLY override to FALSE if your barbarian does not use Strength to make melee attacks\n//!!!\t\t\t\t\t\t\t\t\t\t\t\tand therefore does not get the Rage bonus to melee weapon attack damage.\n//!!!\n\t\t\tconst strAttacks = true;\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tEXPERIMENTAL MACRO ICON/NAME TOGGLE\t\tIf enabled, the macro icon and name toggles based on the barbarian's rage state.\n//!!!\t\t\t\t\t\t\t\t\t\t\tCAUTIONS: \t1. \tThis feature is off by default and is intended for ADVANCED USERS ONLY.\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t2. \tRequires configuration using \"The Furnace\" module for a player to run!\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tThe GM needs to grant The Furnace's \"Run as GM\" permission for this macro.\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t3. \tWorks best with only one barbarian using this feature at a time.\n\n\t\t\t//To auto-toggle the macro's icon/name, override toggleMacro to true below.\n\t\t\tconst toggleMacro = false;\n\n\t\t\t//To use a different icon, manually change the filepath here\n\t\t\tconst stopRageIconPath = 'icons/svg/unconscious.svg';\n\n\t\t\t//You must update the following constant to this macro's exact name for the macro icon toggling to work.\n\t\t\tconst rageMacroName = 'Rage';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//declarations\nlet barb = '';\nlet chatMsg = '';\nlet bear = '';\nlet noRage = false;\nlet rageDmgAdded = false;\nlet toggleResult = false;\nlet macroActor = actor;\nlet macroToken = token;\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tLOCALIZATION SUPPORT\t\t\t\tSets names of D&D5E features as constants instead of hardcoding to allow easier translation.\n//!!!\t\t\t\t\t\t\t\t\t\tSets error messages and flavor text as constants also for easier translation.\n//!!!\n\t\t\t//MUST MATCH VALUES IN CHARACTER SHEET (if present)\n\t\t\tconst barbClassName = 'Barbarian';\n\t\t\tconst rageResourceName = 'Rage';\n\t\t\tconst bearTotemFeatureName = 'Totem Spirit: Bear';\n\n\t\t\t//All remaining values may be changed freely\n\n\t\t\t//Rage chat message flavor text. Actor's name appears immediately before these two strings in the message.\n\t\t\tconst rageMsg = ' is RAAAAAGING!'\n\t\t\tconst endRageMsg =  ' is no longer raging.';\n\n\t\t\t//error and warning messages\n\t\t\tconst errorSelectBarbarian = 'Please select a single barbarian token.';\n\t\t\tconst errorNoRage = ' does not have any rage left, time for a long rest!';\n\t\t\tconst warnMacroNotFound = ' is not a valid macro name, please fix. Rage toggle successful but unable to alter macro.';\n\t\t\tconst errorSelectToken = 'Please select a token.';\n\t\t\tconst errorFailRevert = 'Failed to revert global melee weapon attack bonus, please check manually.';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n\n//main\n//check to see if Actor exists and is a barbarian\nif (macroActor !== undefined && macroActor !== null) {\n\n\t// get the barbarian class item\n\tbarb = macroActor.items.find(i => i.name === `${barbClassName}`);\n\tif (barb == undefined) {\n\t\tui.notifications.warn(`${errorSelectBarbarian}`);\n\t}\n\tif (barb !== undefined && barb !== null) {\n\t\tchatMsg = `${macroActor.name} + rageMsg`;\n\t\tlet enabled = false;\n\t\t// Store the state of the rage toggle flags that indicate if rage is active or not\n\t\tif (macroActor.data.flags.rageMacro !== null && macroActor.data.flags.rageMacro !== undefined) {\n\t\t\tenabled = true;\n\t\t\t\t// Store whether there is also a rage damage bonus currently active\n\t\t\t\tif (macroActor.data.flags.rageMacro[\"rageDmgAdded\"] == true) {\n\t\t\t\t\trageDmgAdded = true;\n\t\t\t\t}\n\t\t}\n\n\t\t//Calculate rage value for use in damage reversion and application\n\t\t// Determining the barbarian level\n\t\tlet barblvl = barb.data.data.levels;\n\n\t\t// Formula to determine the rage bonus damage depending on barbarian level\n\t\tlet lvlCorrection =  barblvl === 16 || barblvl === 17 ? 1 : 0;\n\t\tlet rageDmg = 2 + Math.floor(barblvl / 9) + lvlCorrection;\n\t\tlet dmg = JSON.parse(JSON.stringify(macroActor.data.data.bonuses.mwak.damage));\n\n\t\t// if rage is active, disable it\n\t\tif (enabled) {\n\t\t\tchatMsg = `${macroActor.name} ${endRageMsg}`;\n\t\t\t// reset resistances and melee weapon attack bonus\n\t\t\tlet obj = {};\n\t\t\tobj['flags.rageMacro'] = null;\n\t\t\t//revert damage resistances\n\t\t\tobj['data.traits.dr'] = macroActor.data.flags.rageMacro.oldResistances;\n\n\t\t\t//carefully revert rage global mwak damage bonus to original value, if that bonus is active\n\t\t\t//eventually want to add support so only last instance found is replaced.\n\t\t\tif(rageDmgAdded) {\n\t\t\t\tif (dmg == rageDmg || dmg == null || dmg == undefined || dmg == '' || dmg == 0){\n\t\t\t\t\tconsole.log('Removing simple rage damage');\n\t\t\t\t\tobj['data.bonuses.mwak.damage']='';\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log('Removing complex rage damage');\n\t\t\t\t\tlet patt = `\\\\s\\\\+\\\\s${rageDmg}($|[^0123456789dkrxcm(@{])`;\n\t\t\t\t\tlet result = dmg.search(patt);\n\t\t\t\t\tif (result !== -1) {\n\t\t\t\t\t\tlet len = ('' + rageDmg).length;\n\t\t\t\t\t\tlet origDmg = duplicate(dmg);\n\t\t\t\t\t\tlet firstHalfDmg = duplicate(dmg).substring(0,result);\n\t\t\t\t\t\t//Test String: 2d6 + 2 + 2d6\n\t\t\t\t\t\tlet lastHalfDmg = duplicate(dmg).substring(result+3+len, origDmg.length);\n\t\t\t\t\t\tdmg = `${firstHalfDmg}${lastHalfDmg}`;\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage']=dmg;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tui.notifications.error(`${errorFailRevert}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tmacroActor.update(obj);\n\n\t\t// if rage is disabled, enable it\n\t\t} else {\n\t\t\tif (deductResource) {\n\t\t\t\tlet hasAvailableResource = false;\n\t\t\t\tlet newResources = duplicate(macroActor.data.data.resources)\n\t\t\t\tlet obj = {}\n\t\t\t\t// Look for Resources under the Core macroActor data\n\t\t\t\tlet resourceKey = Object.keys(macroActor.data.data.resources).filter(k => macroActor.data.data.resources[k].label === `${rageResourceName}`).shift();\n\t\t\t\tif (resourceKey && (macroActor.data.data.resources[resourceKey].value > 0 || !preventNegativeResource)) {\n\t\t\t\t\thasAvailableResource = true;\n\t\t\t\t\tnewResources[resourceKey].value--;\n\t\t\t\t\tobj['data.resources'] = newResources \n\t\t\t\t\tmacroActor.update(obj);\n\t\t\t\t}\n\t\t\t\tif (!hasAvailableResource) {\n\t\t\t\t\tui.notifications.error(`${macroActor.name} ${errorNoRage}`);\n\t\t\t\t\tnoRage=true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//activate rage if there is rage available, or if it is okay to rage with 0 resources\n\t\t\tif (!noRage) {\n\t\t\t\tchatMsg = `${macroActor.name} ${rageMsg}`;\n\t\t\t\t// update resistance\n\t\t\t\tlet obj = {};\n\t\t\t\t// storing old resistances in flags to restore later\n\t\t\t\tobj['flags.rageMacro.enabled'] = true;\n\t\t\t\tobj['flags.rageMacro.oldResistances'] = JSON.parse(JSON.stringify(macroActor.data.data.traits.dr));\n\t\t\t\t// add bludgeoning, piercing and slashing resistance\n\t\t\t\tlet newResistance = duplicate(macroActor.data.data.traits.dr);\n\t\t\t\tif (newResistance.value.indexOf('bludgeoning') === -1) newResistance.value.push('bludgeoning');\n\t\t\t\tif (newResistance.value.indexOf('piercing') === -1) newResistance.value.push('piercing');\n\t\t\t\tif (newResistance.value.indexOf('slashing') === -1) newResistance.value.push('slashing');\n\t\t\t\t//If bear totem, add bear totem resistances.\n\t\t\t\tbear = macroActor.items.find(i => i.name === `${bearTotemFeatureName}`)\n\t\t\t\tif (bear !== undefined && bear!== null) {\n\t\t\t\t\tif (newResistance.value.indexOf('acid') === -1) newResistance.value.push('acid');\n\t\t\t\t\tif (newResistance.value.indexOf('cold') === -1) newResistance.value.push('cold');\n\t\t\t\t\tif (newResistance.value.indexOf('fire') === -1) newResistance.value.push('fire');\n\t\t\t\t\tif (newResistance.value.indexOf('force') === -1) newResistance.value.push('force');\n\t\t\t\t\tif (newResistance.value.indexOf('lightning') === -1) newResistance.value.push('lightning');\n\t\t\t\t\tif (newResistance.value.indexOf('necrotic') === -1) newResistance.value.push('necrotic');\n\t\t\t\t\tif (newResistance.value.indexOf('poison') === -1) newResistance.value.push('poison');\n\t\t\t\t\tif (newResistance.value.indexOf('radiant') === -1) newResistance.value.push('radiant');\n\t\t\t\t\tif (newResistance.value.indexOf('thunder') === -1) newResistance.value.push('thunder');\n\t\t\t\t}\n\t\t\t\tobj['data.traits.dr'] = newResistance;\n\t\t\t\tmacroActor.update(obj);\n\n\t\t\t\t// For Strength barbarians, update global melee weapon attack bonus to include rage bonus\n\t\t\t\tif (strAttacks) {\n\t\t\t\t\tobj['flags.rageMacro.rageDmgAdded'] = true;\n\t\t\t\t\t// Preserve old mwak damage bonus if there was one, just in case\n\t\t\t\t\tobj['flags.rageMacro.oldDmg'] = JSON.parse(JSON.stringify(dmg));\n\t\t\t\t\t//actually add the bonus rage damage to the previous bonus damage\n\t\t\t\t\t//respect roll formulas by doing string addition if value is already present.\n\t\t\t\t\tif (dmg == null || dmg == undefined || dmg == 0 || dmg == '') {\n\t\t\t\t\t\tconsole.log('Adding simple rage damage');\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage'] = rageDmg;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log('Adding complex rage damage');\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage'] = `${dmg} + ${rageDmg}`;\n\t\t\t\t\t}\n\t\t\t\t\tmacroActor.update(obj);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!noRage) {\n\t\t\t// toggle rage icon, if rage path is defined above\n\t\t\t(async () => { \n\t\t\t\ttoggleResult = await macroToken.toggleEffect(rageIconPath);\n\t\t\t\tif (toggleResult == enabled) macroToken.toggleEffect(rageIconPath);  \n\t\t\t})();\n\t\t\t\n\t\t\t//toggle macro icon and name, if macro name is correct and stop rage icon path is defined\n\t\t\tlet rageMacro = game.macros.getName(rageMacroName);\n\t\t\t\t//check for name of macro in its \"off\" form\n\t\t\t\tif (rageMacro == null || rageMacro == undefined) {\n\t\t\t\t\trageMacro = game.macros.getName('Stop ' + rageMacroName);\n\t\t\t\t}\n\t\t\tlet obj = {};\n\t\t\tif ( (rageMacro !== null && rageMacro !== undefined) && toggleMacro == true && \n\t\t\t\t\t+ (stopRageIconPath !== null && stopRageIconPath !== undefined && stopRageIconPath !== '') ) {\n\t\t\t\tif (enabled) {\n\t\t\t\t  obj['img'] = rageIconPath;\n\t\t\t\t  obj['name'] = rageMacroName;\n\t\t\t\t} else {\n\t\t\t\t  obj['img'] = stopRageIconPath;\n\t\t\t\t  obj['name'] = 'Stop ' + rageMacroName;\n\t\t\t\t}\n\t\t\t\trageMacro.update(obj);\n\t\t\t} else {\n\t\t\tif (toggleMacro == true) ui.notifications.warn(`${rageMacroName} ${warnMacroNotFound}`);\n\t\t\t}\n\t\t}\n\t}\n} else ui.notifications.warn(errorSelectToken);\n// write to chat if needed:\nif (chatMsg !== '') {\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\tspeaker: ChatMessage.getSpeaker(),\n\t\tcontent: chatMsg\n\t};\n\tChatMessage.create(chatData, {});\n}\n\nif (token)\n  MacroMarker.toggle(this, { entity: token });","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"systems/dnd5e/icons/skills/red_10.jpg","tooltip":"Rage-Macro","colour":"#ff6600","trigger":""},"markers":{"markers":{"jv8ZYVc1mcpm4svY":true},"type":"Token"}},"combat-utility-belt":{"macroTrigger":""},"core":{"sourceId":"Macro.CgAyK40KyztIirYa"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}}}
{"name":"REMOVE CUB Effects","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/Effect_remove_CUB.png","scope":"global","command":"game.cub.removeAllConditions()","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"Show Active/Passive Effects","colour":"#ff0000","trigger":""}},"core":{"sourceId":"Macro.SnRtyqW34JPBMHwG"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"3hFzO3L2POfHXjqJ"}
{"name":"Shortsword","type":"script","author":"05k4ub2VgC3VLxAg","img":"systems/dnd5e/icons/items/weapons/sword-short.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Shortsword\");","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"dnd5e":{"itemMacro":true},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"se2Xb739oTyZqate"}
{"name":"Shortsword (sem bonus)","type":"script","author":"05k4ub2VgC3VLxAg","img":"systems/dnd5e/icons/items/weapons/dagger-leaf.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Shortsword (sem bonus)\");","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"dnd5e":{"itemMacro":true},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"jEX5GlQZz2RVK1bN"}
{"name":"Show_DAE_Effect","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/Show_effects.png","scope":"global","command":"new DAE.ActiveEffects(actor, {}).render(true)","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.zTEAaKrJTPbu5feQ"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"8Y6vDMPhlk17otND"}
{"name":"sleepm","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"let sleepHp = args[0].damageTotal;\n\nif(!sleepHp) {\n  ui.notifications.error(\"No arguments passed to Sleep macro\");\n  return;\n}\nconsole.log(`starting Sleep macro with sleepHp[${sleepHp}]`);\n\n// Get Targets\nlet targets = args[0].targets\nlet newTargets = targets.map(a => canvas.tokens.get(a._id))\n\n// Sort targets by HP ascending\nnewTargets = newTargets.sort(function(a, b) {\n  const hpValueOfA = a.actor.data.data.attributes.hp.value;\n  const HpValueOfB = b.actor.data.data.attributes.hp.value;\n  return hpValueOfA - HpValueOfB;\n});\n\nlet remainingSleepHp = sleepHp;\nconst condition = \"Unconscious\";\nfor(let target of newTargets) {\n  // Skip targets already unconscious\n  if(await game.cub.hasCondition(condition, target.actor)) {\n    console.log(`${target.actor.name} is already asleep, skipping it.`);\n    continue;\n  }\n\n  let targetHpValue = target.actor.data.data.attributes.hp.value;\n  if(remainingSleepHp > targetHpValue) {\n    remainingSleepHp -= targetHpValue;\n    console.log(`${target.actor.name} with hp ${targetHpValue} falls asleep, remaining hp from dice ${remainingSleepHp}.`);\n    // Apply unconscious condition to target\n    game.cub.addCondition(condition, target.actor);\n  } else {\n    console.log(`${target.actor.name} with hp ${targetHpValue} resists asleep, skipping remaining targets.`);\n    break;\n  }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"advanced-macros":{"runAsGM":true},"combat-utility-belt":{"macroTrigger":""},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"JnUcnR9P320dI9Fh"}
{"name":"sneaak","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/jb2a_patreon/Library/1st_Level/Sneak_Attack/Sneak_Attack_Dark_Green_Thumb.webp","scope":"global","command":"//You'll need the module Sequence from Wasp to be Able to use this macro.\n//https://github.com/fantasycalendar/FoundryVTT-Sequencer\n//This macro is for Melee Attack only.\n//DON'T FORGET TO DOWNLOAD THE WEBM FILES FOR THE SNEAK ATTACK TEXT ANIMATION. Available here : https://drive.google.com/drive/folders/16wwmgELRDyL3JG-Zw3k_8PTjJP5aUysX?usp=sharing\n//Add the downloaded files inside this directory /Library/Generic/UI/\n\n//The paths are made for the patreon module, change \"jb2a_patreon\" but \"JB2A_DnD5e\" in each paths below. (without quotation marks)\n\nlet target = Array.from(game.user.targets)[0];\n\nlet sequence = new Sequence()\n    .effect()\n        .file(\"modules/jb2a_patreon/Library/1st_Level/Sneak_Attack/Sneak_Attack_Dark_Green_300x300.webm\") //Choose the variation of Sneak Attack you want to use.\n        .atLocation(canvas.tokens.controlled[0])\n        .JB2A()\n        .anchor({ x: 0.5, y: 1 })\n        .scale(.7)\n    .effect()\n        .file(\"modules/jb2a_patreon/Library/Generic/UI/SneakAttackText_01_Dark_Red_400x400.webm\") //Choose the Sneak Attack text animation by choosing SneakAttackText01 or SneakAttackText02\n        .atLocation(canvas.tokens.controlled[0])\n        .JB2A()\n        .anchor({ x: 0.5, y: 0.25 })\n        .scale(.7)\n    .effect()\n    .file(\"modules/jb2a_patreon/Library/Generic/Weapon_Attacks/Melee/Sword01_Fire_Regular_Red_800x600.webm\") //Choose your melee attack animation in our Library/Generic/Weapon_Attack/Melee directory.\n    .atLocation(canvas.tokens.controlled[0])\n    .reachTowards(target)\n    .JB2A()\n    .delay(2000) //This is a delay before the melee attack begins. The value is in milliseconds, modify it as you wish. You can delete the line if you don't want the delay.\n    .mirrorY()\n    .play()","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":false},"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"ygpREINHDGTSd8WT"}
{"name":"Sneak Attack-Liga/Desliga","type":"script","author":"05k4ub2VgC3VLxAg","img":"systems/dnd5e/icons/skills/violet_27.jpg","scope":"global","command":"//\t\tDISCLAIMER:\t\tThis macro is heavily based on the original D&D 5e Rage Macro masterwork written by Felix#6196.\n//\t\t\t\t\t\tNorc#5108 created and is maintaining this macro.\n//\n//\t\t\t\t\t\tUpdates:\t1.\t2020/06/05: Initial version.\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tBonus Tip: Sneak Attack as a Condition                                                                                                                       \n//!!!\tIf you use the Combat Utility Belt module's Condition Lab, try adding a condition called \"Sneaky\" with the same icon \t\t\t   \n//!!!\tas the optional sneak attack icon overlay, 'icons/svg/mystery-man-black.svg' by default.  See EXPERIMENTAL MACRO ICON/NAME TOGGLE below.\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!   OPTIONAL TOKEN ICON-\tOn by default. If a path to a sneak attack icon is defined, it displays like a condition on the sneaking rogue.\n//!!!\t\t\t\t\t\t\tTo use a different icon, manually change the filepath below or leave it empty ('') to disable the effect.\n//!!!\nconst sneakIconPath = 'systems/dnd5e/icons/skills/violet_27.jpg';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tEXPERIMENTAL MACRO ICON/NAME TOGGLE\t\tIf enabled, the macro icon and name toggles based on whether the rogue is currently sneaking. \n//!!!\t\t\t\t\t\t\t\t\t\t\tCAUTIONS: \t1. \tThis feature is off by default and is intended for ADVANCED USERS ONLY. \n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t2. \tRequires configuration using \"The Furnace\" module for a player to run!\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tThe GM needs to grant The Furnace's \"Run as GM\" permission for this macro.\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t3. \tWorks best with only one rogue using this feature at a time.\n\n\t\t\t\t//To auto-toggle the macro's icon/name, override toggleMacro to true below.\n\t\t\t\tconst toggleMacro = false;\n\n\t\t\t\t//To use a different icon, manually change the filepath here\n\t\t\t\tconst stopSneakIconPath = 'icons/svg/cowled.svg';\n\n\t\t\t\t//You must update the following constant to this macro's exact name for the macro icon toggling to work.\n\t\t\t\tconst sneakMacroName = 'Sneak Attack';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\nlet toggleResult = false;\nlet enabled = false;\nlet errorReason = '';\nlet sneakAttack = {};\nlet rogue = {};\nlet rogueLvls = 0;\nlet sneakDice = 0;\nlet chatMsg = '';\nlet oldMDmg = '';\nlet oldRDmg = '';\n\nlet macroActor = actor;\nlet macroToken = token;\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tBASIC LOCALIZATION SUPPORT\t\t\t\tSets names of D&D5E features as constants instead of hardcoding to allow easier translation.\n//!!!\t\t\t\t\t\t\t\t\t\t\tSets error messages as constants also for easier translation.\n\n\t\t\t\tconst rogueClassName = 'Rogue';\n\t\t\t\tconst sneakAttackFeatureName = 'Sneak Attack';\n\n\t\t\t\tconst errorSelectRogue = 'Please select a single rogue token.';\n\t\t\t\tconst warnMacroNotFound = ' is not a valid macro name, please fix. Sneak attack toggle successful but unable to alter macro.';\n\t\t\t\tconst errorSelectToken = 'Please select a token.';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n\n//check to ensure token is selected and attempt to define the sneak attack feature\nif (macroActor !== null && macroActor !== undefined) {\n\tsneakAttack = macroActor.items.find(i => i.name == `${sneakAttackFeatureName}`);\n} else {\nerrorReason = `${errorSelectToken}`;\n}\n\n//check to ensure token is a rogue\nif (errorReason == '' && macroActor.items.find(i => i.name == `${rogueClassName}`) !== undefined) {\n\trogue = macroActor.items.find(i => i.name == `${rogueClassName}`);\n} else {\n\terrorReason = `${errorSelectRogue}`;\n}\n\nconsole.log(`Error reason is: ${errorReason}`);\n//main execution now that errors are caught\n\nif (errorReason == '') {\n\t\n\tchatMsg = '';\n\tlet enabled = false;\n\t// store the state of the sneak attack toggle in flags\n\tif (macroActor.data.flags.sneakMacro !== null && macroActor.data.flags.sneakMacro !== undefined) {\n\t\tenabled = true;\n\t}\n\t\n\t// if sneak attack is active, disable it\n\tif (enabled) {\n\t\tchatMsg = `${macroActor.name} is no longer sneak attacking.`;\n\t\t// ranged and melee weapon attack bonus\n\t\tlet obj = {};\n\t\tobj['flags.sneakMacro'] = null;\t\t\n\t\tobj['data.bonuses.mwak.damage'] = macroActor.data.flags.sneakMacro.oldMDmg;\t\t\t\n\t\tobj['data.bonuses.rwak.damage'] = macroActor.data.flags.sneakMacro.oldRDmg;\t\n\t\tmacroActor.update(obj);\n\t\t\n\t// if sneak attack is disabled, enable it\n\t} else {\t\t\n\t\tchatMsg = `${macroActor.name} starts sneak attacking!`;\n\t\t\n\t\tlet obj = {};\n\t\tobj['flags.sneakMacro.enabled'] = true;\n\n\t\t// Preserve old mwak damage bonus if there was one\n\t\tlet oldMDmg = macroActor.data.data.bonuses.mwak.damage;\n\t\tif (oldMDmg==null || oldMDmg == undefined || oldMDmg == '') oldMDmg = 0;\n\t\tobj['flags.sneakMacro.oldMDmg'] = JSON.parse(JSON.stringify(oldMDmg));\n\n\t\t// Preserve old rwak damage bonus if there was one\n\t\tlet oldRDmg = macroActor.data.data.bonuses.rwak.damage;\n\t\tif (oldRDmg==null || oldRDmg == undefined || oldRDmg == '') oldRDmg = 0;\n\t\tobj['flags.sneakMacro.oldRDmg'] = JSON.parse(JSON.stringify(oldRDmg));\n\n\t\t\n\t\t// Determining the rogue level\n\t\trogueLvls = rogue.data.data.levels;\n\n\t\t// Formula to determine the sneak attack damage depending on rogue level\t\n\t\tsneakDice = Math.ceil(rogueLvls/2);\n\t\n\t\t//actually add the bonus sneak attack damage to the previous bonus damage\n\t\t//respect roll formulas if present.\n\t\tif (oldMDmg==null || oldMDmg == undefined || oldMDmg == '' || oldMDmg == 0) {\n\t\t\tobj['data.bonuses.mwak.damage'] = `${sneakDice}d6`;\n\t\t} else {\n\t\t\tobj['data.bonuses.mwak.damage'] = `${oldMDmg} + ${sneakDice}d6`;\n\t\t}\n\n\t\tif (oldRDmg==null || oldRDmg == undefined || oldRDmg == '' || oldRDmg == 0) {\n\t\t\tobj['data.bonuses.rwak.damage'] = `${sneakDice}d6`;\n\t\t} else {\n\t\t\tobj['data.bonuses.rwak.damage'] = `${oldRDmg} + ${sneakDice}d6`;\n\t\t}\t\n\n\t\tmacroActor.update(obj);\n\n\t}\t\n\t\n\t//mark or unmark character's token with Sneaky effect icon, if sneakIconPath is defined\n\t(async () => { \n\t\ttoggleResult = await macroToken.toggleEffect(sneakIconPath);\n\t\tif (toggleResult == enabled) macroToken.toggleEffect(sneakIconPath);  \n\t})();\n\n\t//toggle macro icon and name, if enabled\n\tif (toggleMacro) {\n//\t\tNorc's preferred icons, not sure if publicly available\n//\t\tsneakyMacroImgPath = 'systems/dnd5e/icons/skills/shadow_17.jpg';\n//\t\tstopSneakIconPath = 'systems/dnd5e/icons/skills/yellow_11.jpg';\n\t\tlet sneakMacro = game.macros.getName(sneakMacroName);\n\t\t\t//Also check for name of macro in its \"off\" form\n\t\t\tif (sneakMacro == null || sneakMacro == undefined) {\n\t\t\t\tsneakMacro = game.macros.getName('Stop ' + sneakMacroName);\n\t\t\t}\n\t\tlet obj = {};\n\t\tif ( (sneakMacro !== null && sneakMacro !== undefined) && \n\t\t\t\t+ (stopSneakIconPath !== null && stopSneakIconPath !== undefined && stopSneakIconPath !== '') ) {\n\t\t\tif (enabled) {\n\t\t\tobj['img'] = sneakIconPath;\n\t\t\tobj['name'] = sneakMacroName;\n\t\t\t} else {\n\t\t\tobj['img'] = stopSneakIconPath;\n\t\t\tobj['name'] = 'Stop ' + sneakMacroName;\n\t\t\t}\n\t\t\tsneakMacro.update(obj);\n\t\t} else {\n\t\tui.notifications.warn(`${sneakMacroName} ${warnMacroNotFound}`);\t\t\t\n\t\t}\n\t}\n\n} else {\nui.notifications.error(`${errorReason}`);\t\n}\nif (chatMsg !== '') {\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\tspeaker: ChatMessage.getSpeaker(),\n\t\tcontent: chatMsg\n\t};\n\tChatMessage.create(chatData, {});\n}\nif (token)\n  MacroMarker.toggle(this, { entity: token });","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"systems/dnd5e/icons/skills/violet_27.jpg","tooltip":"Sneak Attack","colour":"#5945bf","trigger":""},"markers":{"markers":{"7rVA5gxptaEoIlko":false,"vULyikA5UVDqO4s0":false},"type":"Token"}},"combat-utility-belt":{"macroTrigger":""},"core":{"sourceId":"Macro.hqzyhAjIeRfEca6K"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"lIWIkgyhn3ND9OtJ"}
{"name":"SneakAttack_Sword_Sequencer","type":"script","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"//You'll need the module Sequence from Wasp to be Able to use this macro.\n//https://github.com/fantasycalendar/FoundryVTT-Sequencer\n//This macro is for Melee Attack only.\n//DON'T FORGET TO DOWNLOAD THE WEBM FILES FOR THE SNEAK ATTACK TEXT ANIMATION. Available here : https://drive.google.com/drive/folders/16wwmgELRDyL3JG-Zw3k_8PTjJP5aUysX?usp=sharing\n//Add the downloaded files inside this directory /Library/Generic/UI/\n\n//The paths are made for the patreon module, change \"jb2a_patreon\" but \"JB2A_DnD5e\" in each paths below. (without quotation marks)\n\nlet target = Array.from(game.user.targets)[0];\nconsole.log(args);\n\nconst effectName = \"Sneak Attack\";\nconst myToken = canvas.tokens.controlled[0] || game.user.character.getActiveTokens()[0];\nif (myToken.actor.effects.find(ef=> ef.data.label === effectName)) {\n\n  let sequence = new Sequence()\n    .effect()\n        .file(\"modules/jb2a_patreon/Library/1st_Level/Sneak_Attack/Sneak_Attack_Dark_Green_300x300.webm\") //Choose the variation of Sneak Attack you want to use.\n        .atLocation(canvas.tokens.controlled[0])\n        .JB2A()\n        .anchor({ x: 0.5, y: 1 })\n        .scale(.5)\n    .effect()\n        .file(\"modules/jb2a_patreon/Library/Generic/UI/SneakAttackText_01_Dark_Red_400x400.webm\") //Choose the Sneak Attack text animation by choosing SneakAttackText01 or SneakAttackText02\n        .atLocation(canvas.tokens.controlled[0])\n        .JB2A()\n        .anchor({ x: 0.5, y: 0.25 })\n        .scale(.5)\n    .effect()\n    .file(\"modules/jb2a_patreon/Library/Generic/Weapon_Attacks/Melee/Sword01_Fire_Regular_Red_800x600.webm\") //Choose your melee attack animation in our Library/Generic/Weapon_Attack/Melee directory.\n    .atLocation(canvas.tokens.controlled[0])\n    .reachTowards(target)\n    .JB2A()\n    .delay(2000) //This is a delay before the melee attack begins. The value is in milliseconds, modify it as you wish. You can delete the line if you don't want the delay.\n    .mirrorY()\n    .missed(args[0].hitTargets.length === 0)\n    .play()\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":false},"exportSource":{"world":"tesira","system":"dnd5e","coreVersion":"0.8.8","systemVersion":"1.3.6"},"macro-marker":{"activeData":{"tooltip":"SneakAttack_Sword_Sequencer","icon":"icons/svg/dice-target.svg","colour":"#ff0000","trigger":""}},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"gT7OengcZsS8Cl4W"}
{"name":"Sorcerer point macro","type":"script","author":"05k4ub2VgC3VLxAg","img":"systems/dnd5e/icons/skills/nature_07.jpg","scope":"global","command":"/*\n  Sorcery Point Macro\n  Requirements : \n    1. Character or Token must possess \n      A. A level in \"Sorcerer\"\n      B. Item named \"Font of Magic\"\n      C. Optional : Items appropriately named for Specific Metamagics\n*/\n\nlet log = (...args) => console.log(\"Sorcery Point Macro | \", ...args);\nlet wait = async (ms) => new Promise((resolve)=> setTimeout(resolve, ms));\nlet macroActor = character !== null ? character : token.actor;\nlet data = { items : [], spellSlots : [], sorcPoints : {}, cost : [2,3,5,6,7], spellDiff : false, pointDiff : false};\nlet display_message = true;\nlet dialog_id = randomID();\n\n(async ()=>{\n  await dataCheck();\n\n  log(data);\n\n  updateDialog();\n})();\n\n  //execute choice\n\n  //display choice (if the user wants it)\n\n\nasync function dataCheck()\n{\n  let items = [\n    \"Sorcerer\", \n    \"Font of Magic\", \n    \"Metamagic: Careful Spell\", \n    \"Metamagic: Distant Spell\", \n    \"Metamagic: Empowered Spell\", \n    \"Metamagic: Extended Spell\", \n    \"Metamagic: Heightened Spell\", \n    \"Metamagic: Quickened Spell\", \n    \"Metamagic: Subtle Spell\", \n    \"Metamagic: Twinned Spell\"\n  ];\n\n  if(!macroActor) return error(`No Actor Selected (Character or Token)`);\n\n  items.forEach(name =>{\n    let item = macroActor.items.getName(name);\n\n    if(!item) data.items.push({_id : null, name });\n    else data.items.push({_id : item.id, name});\n  });\n\n  Object.entries(macroActor.data.data.spells).filter(([key, value])=> key !== `spell0`).forEach(([key, {value, max}])=>{\n\t\tdata.spellSlots.push({ slot : key === `pact` ? key : parseInt(key.charAt(5)), value, max });\n  });\n\n  if(!checkAction(`Sorcerer`)) return error(`${macroActor.name} does not have a level in Sorcerer`);\n  if(!checkAction(`Font of Magic`)) return error(`${macroActor.name} does not have the Font of Magic item/feature.`);\n\n  await fixFont();\n\n  async function fixFont()\n  {\n    let font = macroActor.items.getName(\"Font of Magic\");\n    let { levels } = macroActor.items.getName(\"Sorcerer\").data.data;\n    let { uses } = font.data.data;\n\n    if(uses.max !== levels)\n    {\n      let difference = levels - uses.max;\n      uses.max = levels;\n      uses.value = levels - difference;\n      await font.update({ \"data.uses\" : uses });\n    }\n\t\tdata.sorcPoints = uses.value !== null ? uses : {...uses, value : 0 };\n\t\t\n\t\tlog(data.sorcPoints);\n  }\n}\nfunction checkSlotsAvailable()\n{\n  return data.spellSlots.reduce((acc, val) => val.value > 0 || acc, false);\n}\nfunction checkSlotsMissing()\n{\n  return data.spellSlots.reduce((acc, val) => val.value !== val.max || acc, false);\n}\nfunction error(message)\n{\n  ui.notifications.error(message);\n  return new Error(message);\n}\nasync function updateDialog()\n{\n  let interval, content, buttons, dialog, interval_time, last_action;\n  \n  interval_time = 0.2;\n\n  content = getContent();\n\tbuttons = { Cancel : { label : `Cancel` }, Ok : { label : `Ok`, callback : (html) => { executeHTML(html); }}};\n  dialog = new Dialog({ title : `Sorcerer Point Macro`, content, buttons, close : ()=> { clearInterval(interval); }}).render(true);\n\n  interval = setInterval(()=>{\n\t\tlet {action} = getHTML();\n    if(last_action !== action)\n    {\n      last_action = action;\n      update();\n    }\n  }, interval_time * 1000);\n\n  function getContent()\n  {\n    return `\n    <div style=\"display:flex; flex-direction:column;\">\n      <div style=\"display:flex; flex-direction:row; justify-content:space-between; align-items:center; flex-grow:2;\">\n        <img style=\"flex: 0 0 36px; margin-right : 5px; justify-content:flex-start;\" src=\"${macroActor.data.img}\" width=\"42\" height=\"42\"/>\n        <h3 style=\"flex : 1; justify-content:flex-end\">${macroActor.data.name} </h3>\n      </div>\n      <div style=\"display:flex; flex-direction:row; justify-content:space-between; align-items:center; flex-grow:1;\">\n        <h3 style=\"flex : 3; justify-content:flex-start;\">Spell Slots : ${data.spellSlots.filter(ss=> ss.value > 0).map(ss=> ss.value).join(`/`)}</h3>\n        <h3 style=\"flex : 2; justify-content:flex-end;\">Sorcery Points : ${data.sorcPoints.value}/${data.sorcPoints.max}</h3>\n      </div>\n      ${getActions()}\n      ${getSecondaryActions()}\n\t\t</div>`;\n\t\t\n\t\tfunction getActions()\n\t\t{\n\t\t\tlet { action, second } = getHTML();\n\t\n\t\t\treturn `\n\t\t\t\t<div style=\"display:flex; flex-direction:row; justify-content:space-between; align-items:center; flex-grow:1;\">\n\t\t\t\t\t<h3 style=\"flex : 1; justify-content:flex-start;\"><label>Select Action : </label></h3>\n\t\t\t\t\t<h3 style=\"flex : 1; justify-content:flex-end;\">\n\t\t\t\t\t\t<select id=\"${dialog_id}actions\">\n\t\t\t\t\t\t\t${(data.sorcPoints.value !== data.sorcPoints.max && checkSlotsAvailable()) ? `<option ${action === `sp` ? `selected` : ``} value=\"sp\">Convert Spell Slots</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 2 && checkSlotsMissing()) ? `<option ${action === `ss` ? `selected` : ``} value=\"ss\">Create Spell Slots</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Careful Spell`)) ? `<option ${action === `careful` ? `selected` : ``} value=\"careful\">Careful Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Distant Spell`)) ? `<option ${action === `distant` ? `selected` : ``} value=\"distant\">Distant Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Empowered Spell`)) ? `<option ${action === `empowered` ? `selected` : ``} value=\"empowered\">Empowered Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Extended Spell`)) ? `<option ${action === `extended` ? `selected` : ``} value=\"extended\">Extended Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 2 && checkAction(`Metamagic: Heightened Spell`)) ? `<option ${action === `heightened` ? `selected` : ``} value=\"heightened\">Heightened Spell</option>`: ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 1 && checkAction(`Metamagic: Quickened Spell`)) ? `<option ${action === `quickened` ? `selected` : ``} value=\"quickened\">Quickened Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 1 && checkAction(`Metamagic: Subtle Spell`)) ? `<option ${action === `subtle` ? `selected` : ``} value=\"subtle\">Subtle Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Twinned Spell`)) ? `<option ${action === `twinned` ? `selected` : ``} value=\"twinned\">Twinned Spell</option>` : ``}\n\t\t\t\t\t\t</select>\n\t\t\t\t\t</h3>\n\t\t\t\t</div>\n\t\t\t\t`;\n\t\t}\n\t\tfunction getSecondaryActions()\n\t\t{\n\t\t\tlet { action, second } = getHTML(), label = ``, options = ``;\n\t\n\t\t\tswitch(action)\n\t\t\t{\n\t\t\t\tcase `sp` :\n\t\t\t\tcase `twinned` :\n\t\t\t\t\tlabel = `Pick Spell Slot : `;\n\t\t\t\t\toptions = data.spellSlots\n\t\t\t\t\t\t.filter(({value})=> value!==0)\n\t\t\t\t\t\t.map(({slot})=>`<option ${second === slot.toString() ? `selected` : ``} value=\"${slot}\">Level ${slot}</option>`).join(``);\n\t\n\t\t\t\t\tif(action === `twinned`)\n\t\t\t\t\t\toptions = `<option ${second === \"0\" ? `selected` : ``} value=\"0\">Cantrip</option>${options}`;\n\t\t\t\t\tbreak;\n\t\t\t\tcase `ss` :\n\t\t\t\t\tlabel = `Pick Spell Slot : `;\n\t\t\t\t\toptions = data.spellSlots\n\t\t\t\t\t\t.filter(({slot, value, max})=> slot < 6 && data.cost[slot-1] <= data.sorcPoints.value && value < max)\n\t\t\t\t\t\t.map(({slot})=> `<option ${second === slot.toString() ? `selected` : ``} value=\"${slot}\">Level ${slot}</option>`).join(``);\n\t\t\t\t\tbreak;\n\t\t\t\tcase `careful` :\n\t\t\t\tcase `distant` : \n\t\t\t\tcase `empowered` : \n\t\t\t\tcase `extended` :\n\t\t\t\tcase `heightened` :\n\t\t\t\tcase `quickened` :\n\t\t\t\tcase `subtle` :\n\t\t\t\t\tlabel = options = ``;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault : \n\t\t\t\t\tlabel = options = `Error`;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\n\t\t\treturn label === `` ? `` : `\n\t\t\t\t<div style=\"display:flex; flex-direction:row; justify-content:space-between; align-items:center; flex-grow:1;\">\n\t\t\t\t\t<h3 style=\"flex : 1; justify-content:flex-start;\"><label>${label}</label></h3>\n\t\t\t\t\t<h3 style=\"flex : 1; justify-content:flex-end;\">\n\t\t\t\t\t\t<select id=\"${dialog_id}secondary\">\n\t\t\t\t\t\t\t${options}\n\t\t\t\t\t\t</select>\n\t\t\t\t\t</h3>\n\t\t\t\t</div>\n\t\t\t\t`;\n\t\t}\n  }\n  function update()\n  {\n    dialog.data.content = getContent();\n    dialog.render(true);\n  }\n  function getHTML()\n  {\n    let action = $.find(`#${dialog_id}actions`)[0]?.value;\n    let second = $.find(`#${dialog_id}secondary`)[0]?.value;\n\n    return { action, second };\n  }\n  async function executeHTML(html)\n  {\n    let html_data = {\n      action : html.find(`#${dialog_id}actions`)[0]?.value,\n      second : html.find(`#${dialog_id}secondary`)[0]?.value\n\t\t};\n\t\tlet level = 0;\n\n    log(\"Action     | \", html_data.action);\n\t\tlog(\"Secondary  | \", html_data.second);\n\n\t\tswitch(html_data.action)\n\t\t{\n\t\t\tcase `sp` :\n\t\t\t\tlevel = parseInt(html_data.second);\t\n\t\t\t\teditSpellSlots(level, -1);\n\t\t\t\teditSorceryPoints(level);\n\t\t\t\tbreak;\n\t\t\tcase `twinned` :\n\t\t\tcase `ss` :\n\t\t\t\tlevel = parseInt(html_data.second);\n\t\t\t\tif(html_data.action === `ss`)\n\t\t\t\t\teditSpellSlots(level,+1);\n\t\t\t\teditSorceryPoints((data.cost[level]-1)*-1);\n\t\t\t\tbreak;\n\t\t\tcase `careful` :\n\t\t\tcase `distant` : \n\t\t\tcase `empowered` : \n\t\t\tcase `extended` :\n\t\t\t\teditSorceryPoints(-1);\n\t\t\t\tbreak;\n\t\t\tcase `quickened` :\n\t\t\tcase `subtle` :\n\t\t\t\teditSorceryPoints(-2);\n\t\t\t\tbreak;\n\t\t\tcase `heightened` :\n\t\t\t\teditSorceryPoints(-3);\n\t\t\t\tbreak;\n\t\t\tdefault : \n\t\t\t\tbreak;\n\t\t}\n\n\t\tawait updateActor();\n\t\tawait executeItem(html_data.action);\n\t}\n}\nfunction checkAction(name)\n{\n\treturn data.items.find(i=>i.name === name)._id !== null;\n}\nfunction editSorceryPoints(num)\n{\n\tdata.sorcPoints.value = Math.clamped(data.sorcPoints.value + num, 0, data.sorcPoints.max);\n\tdata.pointDiff = true;\n}\nfunction editSpellSlots(level, num)\n{\n\tlet obj = {value, max, slot} = data.spellSlots.find(d=> d.slot === level);\n\tlet index = data.spellSlots.indexOf(obj);\n\tdata.spellSlots[index].value = Math.clamped(value + num, 0, max);\n\tdata.spellSlots[index].diff = true;\n\tdata.spellDiff = true;\n}\nasync function executeItem(item_code)\n{\n\tif(!display_message || !item_code  || item_code === `ss` || item_code === `sp` ) return;\n\tlet item_name = data.items.find(i=>i.name.toLowerCase().includes(item_code))?.name;\t\n\n\tif(!item_name) return error(`Failed to find ${item_code}`);\n\n\tawait macroActor.items.getName(item_name)?.roll();\n}\nasync function updateActor()\n{\n\tif(data.pointDiff)\n\t{\n\t\tlet uses = duplicate(data.sorcPoints);\n\t\tawait macroActor.items.getName(\"Font of Magic\").update({ \"data.uses\" : uses });\n\t}\n\n\tif(data.spellDiff)\n\t{\n\t\tlet spells = {};\n\t\tdata.spellSlots.filter(d=> d.diff).forEach(d=> {\n\t\t\tlet key = d.slot === `pact` ? `pact` : `spell${d.slot}`;\n\t\t\tspells[key] = { value : d.value };\n\t\t});\n\n\t\tif(spells === {}) return;\n\t\tawait macroActor.update({\"data.spells\" : spells});\n\t}\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.HzNg1DHlWywQVj0G"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"RFHMM29tVqiKEp7N"}
{"_id":"RFHMM29tVqiKEp7N","name":"Sorcerer point macro","type":"script","author":"05k4ub2VgC3VLxAg","img":"systems/dnd5e/icons/skills/nature_07.jpg","scope":"global","command":"/*\n  Sorcery Point Macro\n  Requirements : \n    1. Character or Token must possess \n      A. A level in \"Sorcerer\"\n      B. Item named \"Font of Magic\"\n      C. Optional : Items appropriately named for Specific Metamagics\n*/\n\nlet log = (...args) => console.log(\"Sorcery Point Macro | \", ...args);\nlet wait = async (ms) => new Promise((resolve)=> setTimeout(resolve, ms));\nlet macroActor = character !== null ? character : token.actor;\nlet data = { items : [], spellSlots : [], sorcPoints : {}, cost : [2,3,5,6,7], spellDiff : false, pointDiff : false};\nlet display_message = true;\nlet dialog_id = randomID();\n\n(async ()=>{\n  await dataCheck();\n\n  log(data);\n\n  updateDialog();\n})();\n\n  //execute choice\n\n  //display choice (if the user wants it)\n\n\nasync function dataCheck()\n{\n  let items = [\n    \"Sorcerer\", \n    \"Font of Magic\", \n    \"Metamagic: Careful Spell\", \n    \"Metamagic: Distant Spell\", \n    \"Metamagic: Empowered Spell\", \n    \"Metamagic: Extended Spell\", \n    \"Metamagic: Heightened Spell\", \n    \"Metamagic: Quickened Spell\", \n    \"Metamagic: Subtle Spell\", \n    \"Metamagic: Twinned Spell\"\n  ];\n\n  if(!macroActor) return error(`No Actor Selected (Character or Token)`);\n\n  items.forEach(name =>{\n    let item = macroActor.items.getName(name);\n\n    if(!item) data.items.push({_id : null, name });\n    else data.items.push({_id : item.id, name});\n  });\n\n  Object.entries(macroActor.data.data.spells).filter(([key, value])=> key !== `spell0`).forEach(([key, {value, max}])=>{\n\t\tdata.spellSlots.push({ slot : key === `pact` ? key : parseInt(key.charAt(5)), value, max });\n  });\n\n  if(!checkAction(`Sorcerer`)) return error(`${macroActor.name} does not have a level in Sorcerer`);\n  if(!checkAction(`Font of Magic`)) return error(`${macroActor.name} does not have the Font of Magic item/feature.`);\n\n  await fixFont();\n\n  async function fixFont()\n  {\n    let font = macroActor.items.getName(\"Font of Magic\");\n    let { levels } = macroActor.items.getName(\"Sorcerer\").data.data;\n    let { uses } = font.data.data;\n\n    if(uses.max !== levels)\n    {\n      let difference = levels - uses.max;\n      uses.max = levels;\n      uses.value = levels - difference;\n      await font.update({ \"data.uses\" : uses });\n    }\n\t\tdata.sorcPoints = uses.value !== null ? uses : {...uses, value : 0 };\n\t\t\n\t\tlog(data.sorcPoints);\n  }\n}\nfunction checkSlotsAvailable()\n{\n  return data.spellSlots.reduce((acc, val) => val.value > 0 || acc, false);\n}\nfunction checkSlotsMissing()\n{\n  return data.spellSlots.reduce((acc, val) => val.value !== val.max || acc, false);\n}\nfunction error(message)\n{\n  ui.notifications.error(message);\n  return new Error(message);\n}\nasync function updateDialog()\n{\n  let interval, content, buttons, dialog, interval_time, last_action;\n  \n  interval_time = 0.2;\n\n  content = getContent();\n\tbuttons = { Cancel : { label : `Cancel` }, Ok : { label : `Ok`, callback : (html) => { executeHTML(html); }}};\n  dialog = new Dialog({ title : `Sorcerer Point Macro`, content, buttons, close : ()=> { clearInterval(interval); }}).render(true);\n\n  interval = setInterval(()=>{\n\t\tlet {action} = getHTML();\n    if(last_action !== action)\n    {\n      last_action = action;\n      update();\n    }\n  }, interval_time * 1000);\n\n  function getContent()\n  {\n    return `\n    <div style=\"display:flex; flex-direction:column;\">\n      <div style=\"display:flex; flex-direction:row; justify-content:space-between; align-items:center; flex-grow:2;\">\n        <img style=\"flex: 0 0 36px; margin-right : 5px; justify-content:flex-start;\" src=\"${macroActor.data.img}\" width=\"42\" height=\"42\"/>\n        <h3 style=\"flex : 1; justify-content:flex-end\">${macroActor.data.name} </h3>\n      </div>\n      <div style=\"display:flex; flex-direction:row; justify-content:space-between; align-items:center; flex-grow:1;\">\n        <h3 style=\"flex : 3; justify-content:flex-start;\">Spell Slots : ${data.spellSlots.filter(ss=> ss.value > 0).map(ss=> ss.value).join(`/`)}</h3>\n        <h3 style=\"flex : 2; justify-content:flex-end;\">Sorcery Points : ${data.sorcPoints.value}/${data.sorcPoints.max}</h3>\n      </div>\n      ${getActions()}\n      ${getSecondaryActions()}\n\t\t</div>`;\n\t\t\n\t\tfunction getActions()\n\t\t{\n\t\t\tlet { action, second } = getHTML();\n\t\n\t\t\treturn `\n\t\t\t\t<div style=\"display:flex; flex-direction:row; justify-content:space-between; align-items:center; flex-grow:1;\">\n\t\t\t\t\t<h3 style=\"flex : 1; justify-content:flex-start;\"><label>Select Action : </label></h3>\n\t\t\t\t\t<h3 style=\"flex : 1; justify-content:flex-end;\">\n\t\t\t\t\t\t<select id=\"${dialog_id}actions\">\n\t\t\t\t\t\t\t${(data.sorcPoints.value !== data.sorcPoints.max && checkSlotsAvailable()) ? `<option ${action === `sp` ? `selected` : ``} value=\"sp\">Convert Spell Slots</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 2 && checkSlotsMissing()) ? `<option ${action === `ss` ? `selected` : ``} value=\"ss\">Create Spell Slots</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Careful Spell`)) ? `<option ${action === `careful` ? `selected` : ``} value=\"careful\">Careful Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Distant Spell`)) ? `<option ${action === `distant` ? `selected` : ``} value=\"distant\">Distant Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Empowered Spell`)) ? `<option ${action === `empowered` ? `selected` : ``} value=\"empowered\">Empowered Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Extended Spell`)) ? `<option ${action === `extended` ? `selected` : ``} value=\"extended\">Extended Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 2 && checkAction(`Metamagic: Heightened Spell`)) ? `<option ${action === `heightened` ? `selected` : ``} value=\"heightened\">Heightened Spell</option>`: ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 1 && checkAction(`Metamagic: Quickened Spell`)) ? `<option ${action === `quickened` ? `selected` : ``} value=\"quickened\">Quickened Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 1 && checkAction(`Metamagic: Subtle Spell`)) ? `<option ${action === `subtle` ? `selected` : ``} value=\"subtle\">Subtle Spell</option>` : ``}\n\t\t\t\t\t\t\t${(data.sorcPoints.value > 0 && checkAction(`Metamagic: Twinned Spell`)) ? `<option ${action === `twinned` ? `selected` : ``} value=\"twinned\">Twinned Spell</option>` : ``}\n\t\t\t\t\t\t</select>\n\t\t\t\t\t</h3>\n\t\t\t\t</div>\n\t\t\t\t`;\n\t\t}\n\t\tfunction getSecondaryActions()\n\t\t{\n\t\t\tlet { action, second } = getHTML(), label = ``, options = ``;\n\t\n\t\t\tswitch(action)\n\t\t\t{\n\t\t\t\tcase `sp` :\n\t\t\t\tcase `twinned` :\n\t\t\t\t\tlabel = `Pick Spell Slot : `;\n\t\t\t\t\toptions = data.spellSlots\n\t\t\t\t\t\t.filter(({value})=> value!==0)\n\t\t\t\t\t\t.map(({slot})=>`<option ${second === slot.toString() ? `selected` : ``} value=\"${slot}\">Level ${slot}</option>`).join(``);\n\t\n\t\t\t\t\tif(action === `twinned`)\n\t\t\t\t\t\toptions = `<option ${second === \"0\" ? `selected` : ``} value=\"0\">Cantrip</option>${options}`;\n\t\t\t\t\tbreak;\n\t\t\t\tcase `ss` :\n\t\t\t\t\tlabel = `Pick Spell Slot : `;\n\t\t\t\t\toptions = data.spellSlots\n\t\t\t\t\t\t.filter(({slot, value, max})=> slot < 6 && data.cost[slot-1] <= data.sorcPoints.value && value < max)\n\t\t\t\t\t\t.map(({slot})=> `<option ${second === slot.toString() ? `selected` : ``} value=\"${slot}\">Level ${slot}</option>`).join(``);\n\t\t\t\t\tbreak;\n\t\t\t\tcase `careful` :\n\t\t\t\tcase `distant` : \n\t\t\t\tcase `empowered` : \n\t\t\t\tcase `extended` :\n\t\t\t\tcase `heightened` :\n\t\t\t\tcase `quickened` :\n\t\t\t\tcase `subtle` :\n\t\t\t\t\tlabel = options = ``;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault : \n\t\t\t\t\tlabel = options = `Error`;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\n\t\t\treturn label === `` ? `` : `\n\t\t\t\t<div style=\"display:flex; flex-direction:row; justify-content:space-between; align-items:center; flex-grow:1;\">\n\t\t\t\t\t<h3 style=\"flex : 1; justify-content:flex-start;\"><label>${label}</label></h3>\n\t\t\t\t\t<h3 style=\"flex : 1; justify-content:flex-end;\">\n\t\t\t\t\t\t<select id=\"${dialog_id}secondary\">\n\t\t\t\t\t\t\t${options}\n\t\t\t\t\t\t</select>\n\t\t\t\t\t</h3>\n\t\t\t\t</div>\n\t\t\t\t`;\n\t\t}\n  }\n  function update()\n  {\n    dialog.data.content = getContent();\n    dialog.render(true);\n  }\n  function getHTML()\n  {\n    let action = $.find(`#${dialog_id}actions`)[0]?.value;\n    let second = $.find(`#${dialog_id}secondary`)[0]?.value;\n\n    return { action, second };\n  }\n  async function executeHTML(html)\n  {\n    let html_data = {\n      action : html.find(`#${dialog_id}actions`)[0]?.value,\n      second : html.find(`#${dialog_id}secondary`)[0]?.value\n\t\t};\n\t\tlet level = 0;\n\n    log(\"Action     | \", html_data.action);\n\t\tlog(\"Secondary  | \", html_data.second);\n\n\t\tswitch(html_data.action)\n\t\t{\n\t\t\tcase `sp` :\n\t\t\t\tlevel = parseInt(html_data.second);\t\n\t\t\t\teditSpellSlots(level, -1);\n\t\t\t\teditSorceryPoints(level);\n\t\t\t\tbreak;\n\t\t\tcase `twinned` :\n\t\t\tcase `ss` :\n\t\t\t\tlevel = parseInt(html_data.second);\n\t\t\t\tif(html_data.action === `ss`)\n\t\t\t\t\teditSpellSlots(level,+1);\n\t\t\t\teditSorceryPoints((data.cost[level]-1)*-1);\n\t\t\t\tbreak;\n\t\t\tcase `careful` :\n\t\t\tcase `distant` : \n\t\t\tcase `empowered` : \n\t\t\tcase `extended` :\n\t\t\t\teditSorceryPoints(-1);\n\t\t\t\tbreak;\n\t\t\tcase `quickened` :\n\t\t\tcase `subtle` :\n\t\t\t\teditSorceryPoints(-2);\n\t\t\t\tbreak;\n\t\t\tcase `heightened` :\n\t\t\t\teditSorceryPoints(-3);\n\t\t\t\tbreak;\n\t\t\tdefault : \n\t\t\t\tbreak;\n\t\t}\n\n\t\tawait updateActor();\n\t\tawait executeItem(html_data.action);\n\t}\n}\nfunction checkAction(name)\n{\n\treturn data.items.find(i=>i.name === name)._id !== null;\n}\nfunction editSorceryPoints(num)\n{\n\tdata.sorcPoints.value = Math.clamped(data.sorcPoints.value + num, 0, data.sorcPoints.max);\n\tdata.pointDiff = true;\n}\nfunction editSpellSlots(level, num)\n{\n\tlet obj = {value, max, slot} = data.spellSlots.find(d=> d.slot === level);\n\tlet index = data.spellSlots.indexOf(obj);\n\tdata.spellSlots[index].value = Math.clamped(value + num, 0, max);\n\tdata.spellSlots[index].diff = true;\n\tdata.spellDiff = true;\n}\nasync function executeItem(item_code)\n{\n\tif(!display_message || !item_code  || item_code === `ss` || item_code === `sp` ) return;\n\tlet item_name = data.items.find(i=>i.name.toLowerCase().includes(item_code))?.name;\t\n\n\tif(!item_name) return error(`Failed to find ${item_code}`);\n\n\tawait macroActor.items.getName(item_name)?.roll();\n}\nasync function updateActor()\n{\n\tif(data.pointDiff)\n\t{\n\t\tlet uses = duplicate(data.sorcPoints);\n\t\tawait macroActor.items.getName(\"Font of Magic\").update({ \"data.uses\" : uses });\n\t}\n\n\tif(data.spellDiff)\n\t{\n\t\tlet spells = {};\n\t\tdata.spellSlots.filter(d=> d.diff).forEach(d=> {\n\t\t\tlet key = d.slot === `pact` ? `pact` : `spell${d.slot}`;\n\t\t\tspells[key] = { value : d.value };\n\t\t});\n\n\t\tif(spells === {}) return;\n\t\tawait macroActor.update({\"data.spells\" : spells});\n\t}\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.HzNg1DHlWywQVj0G"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}}}
{"name":"Stealth Check","type":"script","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/StealthCheck.jpg","scope":"global","command":"// Grabs selected tokens and rolls a stealth check against all other tokens passive perception on the map. Then returns the result.\n\n// getting all actors of selected tokens\nlet actors = canvas.tokens.controlled.map(({ actor }) => actor);\n\n// if there are no selected tokens, roll for the player's character.\nif (actors.length < 1) {\n  actors = game.users.entities.map(entity => {\n    if (entity.active && entity.character !== null) {\n      return entity.character;\n    }\n  });\n}\nconst validActors = actors.filter(actor => actor != null);\n\nlet messageContent = 'pp = passive perception<br>';\n\n// roll for every actor\nfor (const selectedActor of validActors) {\n  const stealthMod = selectedActor.data.data.skills.ste.total; // stealth roll\n  const stealth = new Roll(`1d20+${stealthMod}`).roll().total; // rolling the formula\n  messageContent += `<hr><h3>${selectedActor.name} stealth roll was a <b>${stealth}</b>.</h3>`; // creating the output string\n\n  // grab a list of unique tokens then check their passive perception against the rolled stealth.\n  const uniqueActor = {};\n  const caughtBy = canvas.tokens.placeables\n    .filter(token => !!token.actor)\n    .filter(({ actor }) => { // filter out duplicate token names. ie: we assume all goblins have the same passive perception\n      if (uniqueActor[actor.name]) {\n        return false;\n      }\n      uniqueActor[actor.name] = true;\n      return true;\n    })\n    .filter(({ actor }) => {\n      return selectedActor.id !== actor.id; // Don't check to see if the token sees himself.\n    })\n    .filter(({ actor }) => actor.data.data.skills.prc.passive >= stealth); // check map tokens passives with roller stealth\n\n  if (!caughtBy.length) {\n    messageContent += 'Stealth successful!<br>';\n  } else {\n    messageContent += 'Stealth questionable:<br>';\n    caughtBy.map(({ actor }) => {\n      messageContent += `<b>${actor.name}</b> pp(${actor.data.data.skills.prc.passive}).<br>`;\n    });\n  }\n}\n\n// create the message\nconst chatData = {\n  user: game.user._id,\n  speaker: game.user,\n  content: messageContent,\n  whisper: game.users.entities.filter((u) => u.isGM).map((u) => u._id),\n};\nChatMessage.create(chatData, {});","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"Stealth Check","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"core":{"sourceId":"Macro.RTiO1Z1tasafiWAo"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"NU99QKdQv3MQJDY6"}
{"name":"Toggle DEA via Macro","type":"chat","author":"05k4ub2VgC3VLxAg","img":"modules/GMmacros/img/ToggleDae.png","scope":"global","command":"const nome = \"MeuEfeito\"; // Troque MeuEfeito pelo nome exato do efeito que você quer ligar ou desligar.\n\nconst macroVersion = 'v0.2';\n\n/* Ativar/Desativar Efeito\nSource: https://raw.githubusercontent.com/brunocalado/mestre-digital/master/Foundry%20VTT/Macros/DnD%205e/ToogleAE.js\nIcon: \n*/\n//\n\nif (!actor) {\n  ui.notifications.warn(`Selecione um token!`); // get selected token \n} else {\n  main();\n}\n\nasync function main() {  \n  let effect = canvas.tokens.controlled[0].actor.effects.find(i => i.data.label === nome);\n  if (!effect) {\n    ui.notifications.warn(`Efeito não localizado!`); // get selected token \n  } else {\n    await effect.update({disabled: !effect.data.disabled});            \n    let mensagem = `O efeito <b>${nome}</b> foi <b>${effect.data.disabled?'ligado':'desligado'}</b>`;\n    let chatData = {\n      user: game.user._id,\n      speaker: ChatMessage.getSpeaker(),\n      content: mensagem\n    };  \n    ChatMessage.create(chatData, {});    \n    \n  }\n}","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"macro-marker":{"activeData":{"icon":"icons/svg/dice-target.svg","tooltip":"New Macro","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.5brmSxdf10g513Vt"},"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000"}},"_id":"on7Aa2Oc5wFqz06E"}
{"name":"#[CF_tempEntity]","type":"chat","author":"05k4ub2VgC3VLxAg","img":"icons/svg/dice-target.svg","scope":"global","command":"","folder":null,"sort":0,"permission":{"default":0,"05k4ub2VgC3VLxAg":3},"flags":{"cf":{"id":"temp_ujzml4bcri","path":"Default","color":"#000000","name":"Default","children":["I2CwYQUNWm5iRWOV","I2CwYQUNWm5iRWOV","gvLWLbBdu6RXI0J1","YHE4XqS7fKhyDS59","Gqz3wVrpLRey6niS","Gqz3wVrpLRey6niS","Culwz8ek4VJvcwsf","HWh6dwdeB0WtijaO","aAaWnttas5HAZdcE","vLTe3P1kH02yBLlF","hipAqZJuPgWHPn8K","xMEDw05cZ4ApqMMA","0hVCFcSQ7LaIwzD8","0hVCFcSQ7LaIwzD8","qho7SVuSqDKplZ6g","mYVeh3IuEhXWtxrc","a0VdfIRRvwvY80fd","loLEe53fEj2vHmuP","RXO1KHWtAmZ2eIzE","EEArlPl00LNxXVPv","UoaapIFiQBOaN5PT","yqVFlzjFk6H3hcS1","2g3LlcrN6SDNw9At","0ze1BiNUSZ4dAsL3","0ze1BiNUSZ4dAsL3","yzbfNTD4sU7Ju8FT","ovi30YUB9idwFwSW","E3xFeG0efsBcIWfe","E3xFeG0efsBcIWfe","3hFzO3L2POfHXjqJ","se2Xb739oTyZqate","jEX5GlQZz2RVK1bN","8Y6vDMPhlk17otND","JnUcnR9P320dI9Fh","ygpREINHDGTSd8WT","lIWIkgyhn3ND9OtJ","gT7OengcZsS8Cl4W","RFHMM29tVqiKEp7N","RFHMM29tVqiKEp7N","NU99QKdQv3MQJDY6","on7Aa2Oc5wFqz06E"],"folderPath":[]}},"_id":"n7ToBO32lsH8gHHu"}
